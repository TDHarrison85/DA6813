<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Case Study 3 Sandbox</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CS3_Sandbox_WH_files/libs/clipboard/clipboard.min.js"></script>
<script src="CS3_Sandbox_WH_files/libs/quarto-html/quarto.js"></script>
<script src="CS3_Sandbox_WH_files/libs/quarto-html/popper.min.js"></script>
<script src="CS3_Sandbox_WH_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CS3_Sandbox_WH_files/libs/quarto-html/anchor.min.js"></script>
<link href="CS3_Sandbox_WH_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CS3_Sandbox_WH_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CS3_Sandbox_WH_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CS3_Sandbox_WH_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CS3_Sandbox_WH_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Case Study 3 Sandbox</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="case-study-3-sandbox" class="level2">
<h2 class="anchored" data-anchor-id="case-study-3-sandbox">Case Study 3 Sandbox</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(MASS, tidyverse, here, skimr, rpart, dplyr, VIM, corrplot, car, quantmod, ggplot2, tree, e1071)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>select <span class="ot">&lt;-</span> dplyr<span class="sc">::</span>select</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>raw_index_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">'Case Study 3'</span>, <span class="st">'dow_jones_index.data'</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>raw_index_names <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">'Case Study 3'</span>, <span class="st">'dow_jones_index.names'</span>))</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>SP500_raw <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">'Case Study 3'</span>, <span class="st">'SP500.csv'</span>), <span class="at">sep =</span> <span class="st">','</span>, <span class="at">fileEncoding =</span> <span class="st">'latin1'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(raw_index_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   750 obs. of  16 variables:
 $ quarter                           : int  1 1 1 1 1 1 1 1 1 1 ...
 $ stock                             : chr  "AA" "AA" "AA" "AA" ...
 $ date                              : chr  "1/7/2011" "1/14/2011" "1/21/2011" "1/28/2011" ...
 $ open                              : chr  "$15.82" "$16.71" "$16.19" "$15.87" ...
 $ high                              : chr  "$16.72" "$16.71" "$16.38" "$16.63" ...
 $ low                               : chr  "$15.78" "$15.64" "$15.60" "$15.82" ...
 $ close                             : chr  "$16.42" "$15.97" "$15.79" "$16.13" ...
 $ volume                            : int  239655616 242963398 138428495 151379173 154387761 114691279 80023895 132981863 109493077 114332562 ...
 $ percent_change_price              : num  3.79 -4.43 -2.47 1.64 5.93 ...
 $ percent_change_volume_over_last_wk: num  NA 1.38 -43.02 9.36 1.99 ...
 $ previous_weeks_volume             : int  NA 239655616 242963398 138428495 151379173 154387761 114691279 80023895 132981863 109493077 ...
 $ next_weeks_open                   : chr  "$16.71" "$16.19" "$15.87" "$16.18" ...
 $ next_weeks_close                  : chr  "$15.97" "$15.79" "$16.13" "$17.14" ...
 $ percent_change_next_weeks_price   : num  -4.428 -2.471 1.638 5.933 0.231 ...
 $ days_to_next_dividend             : int  26 19 12 5 97 90 83 76 69 62 ...
 $ percent_return_next_dividend      : num  0.183 0.188 0.19 0.186 0.175 ...</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(raw_index_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">raw_index_data</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">750</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">16</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 22%">
<col style="width: 13%">
<col style="width: 18%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">stock</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">date</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">open</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">722</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">high</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">713</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">low</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">711</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">close</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">711</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">next_weeks_open</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">720</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">next_weeks_close</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">715</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 23%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">quarter</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.52</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">2.000000e+00</td>
<td style="text-align: left;">▇▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">volume</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">117547801.41</td>
<td style="text-align: right;">158438089.36</td>
<td style="text-align: right;">9718851.00</td>
<td style="text-align: right;">30866243.25</td>
<td style="text-align: right;">53060885.00</td>
<td style="text-align: right;">132721823.75</td>
<td style="text-align: right;">1.453439e+09</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">percent_change_price</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">2.52</td>
<td style="text-align: right;">-15.42</td>
<td style="text-align: right;">-1.29</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.65</td>
<td style="text-align: right;">9.880000e+00</td>
<td style="text-align: left;">▁▁▆▇▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">percent_change_volume_over_last_wk</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">5.59</td>
<td style="text-align: right;">40.54</td>
<td style="text-align: right;">-61.43</td>
<td style="text-align: right;">-19.80</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">21.80</td>
<td style="text-align: right;">3.274100e+02</td>
<td style="text-align: left;">▇▃▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">previous_weeks_volume</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">117387644.83</td>
<td style="text-align: right;">159232228.00</td>
<td style="text-align: right;">9718851.00</td>
<td style="text-align: right;">30678320.00</td>
<td style="text-align: right;">52945558.00</td>
<td style="text-align: right;">133322975.25</td>
<td style="text-align: right;">1.453439e+09</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">percent_change_next_weeks_price</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">2.68</td>
<td style="text-align: right;">-15.42</td>
<td style="text-align: right;">-1.22</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">1.85</td>
<td style="text-align: right;">9.880000e+00</td>
<td style="text-align: left;">▁▁▆▇▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">days_to_next_dividend</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">52.53</td>
<td style="text-align: right;">46.34</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: right;">47.00</td>
<td style="text-align: right;">69.00</td>
<td style="text-align: right;">3.360000e+02</td>
<td style="text-align: left;">▇▃▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">percent_return_next_dividend</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.69</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">0.68</td>
<td style="text-align: right;">0.85</td>
<td style="text-align: right;">1.560000e+00</td>
<td style="text-align: left;">▃▇▇▂▂</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(raw_index_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>#It appears we have missing values, We will need to address this in some of our next steps but first we’ll divide the data into train and test</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>missing_values <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">is.na</span>(raw_index_data))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>missing_values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                           quarter                              stock 
                                 0                                  0 
                              date                               open 
                                 0                                  0 
                              high                                low 
                                 0                                  0 
                             close                             volume 
                                 0                                  0 
              percent_change_price percent_change_volume_over_last_wk 
                                 0                                 30 
             previous_weeks_volume                    next_weeks_open 
                                30                                  0 
                  next_weeks_close    percent_change_next_weeks_price 
                                 0                                  0 
             days_to_next_dividend       percent_return_next_dividend 
                                 0                                  0 </code></pre>
</div>
</div>
<p>#Splitting data into training (Q1) and testing (Q2)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">subset</span>(raw_index_data, quarter <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Training data (Q1: Jan-Mar)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">subset</span>(raw_index_data, quarter <span class="sc">==</span> <span class="dv">2</span>)   <span class="co"># Testing data (Q2: Apr-Jun)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#Running correlation check among the numeric variables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(train_data[, <span class="fu">sapply</span>(train_data, is.numeric)], <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in cor(train_data[, sapply(train_data, is.numeric)], use =
"complete.obs"): the standard deviation is zero</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cor_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                   quarter      volume percent_change_price
quarter                                  1          NA                   NA
volume                                  NA  1.00000000         -0.221694454
percent_change_price                    NA -0.22169445          1.000000000
percent_change_volume_over_last_wk      NA  0.19768437         -0.358896850
previous_weeks_volume                   NA  0.86432993         -0.045258948
percent_change_next_weeks_price         NA -0.13167362          0.010374354
days_to_next_dividend                   NA -0.06414402          0.035086236
percent_return_next_dividend            NA -0.27603768         -0.005173395
                                   percent_change_volume_over_last_wk
quarter                                                            NA
volume                                                     0.19768437
percent_change_price                                      -0.35889685
percent_change_volume_over_last_wk                         1.00000000
previous_weeks_volume                                     -0.14112278
percent_change_next_weeks_price                            0.04455945
days_to_next_dividend                                     -0.01836656
percent_return_next_dividend                              -0.01906340
                                   previous_weeks_volume
quarter                                               NA
volume                                        0.86432993
percent_change_price                         -0.04525895
percent_change_volume_over_last_wk           -0.14112278
previous_weeks_volume                         1.00000000
percent_change_next_weeks_price              -0.15477083
days_to_next_dividend                        -0.06300760
percent_return_next_dividend                 -0.27870205
                                   percent_change_next_weeks_price
quarter                                                         NA
volume                                                -0.131673616
percent_change_price                                   0.010374354
percent_change_volume_over_last_wk                     0.044559445
previous_weeks_volume                                 -0.154770828
percent_change_next_weeks_price                        1.000000000
days_to_next_dividend                                 -0.005275484
percent_return_next_dividend                           0.109565562
                                   days_to_next_dividend
quarter                                               NA
volume                                      -0.064144021
percent_change_price                         0.035086236
percent_change_volume_over_last_wk          -0.018366565
previous_weeks_volume                       -0.063007605
percent_change_next_weeks_price             -0.005275484
days_to_next_dividend                        1.000000000
percent_return_next_dividend                 0.100206077
                                   percent_return_next_dividend
quarter                                                      NA
volume                                             -0.276037679
percent_change_price                               -0.005173395
percent_change_volume_over_last_wk                 -0.019063402
previous_weeks_volume                              -0.278702047
percent_change_next_weeks_price                     0.109565562
days_to_next_dividend                               0.100206077
percent_return_next_dividend                        1.000000000</code></pre>
</div>
</div>
<p>#There appears to be correlation between ‘volume’ and keep ‘previous_weeks_volume’-these two had &gt;.8 (high correlation). Which one would be important to keep for predicting our target variable [percent_change_next_weeks_price]?</p>
<p>#I’ve decided to parse out the data variables I believe will be most useful moving forward</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>selected_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'date'</span>, <span class="st">'stock'</span>, <span class="st">"percent_change_next_weeks_price"</span>, <span class="st">"percent_change_price"</span>, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"percent_change_volume_over_last_wk"</span>, <span class="st">"previous_weeks_volume"</span>, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"days_to_next_dividend"</span>, <span class="st">"percent_return_next_dividend"</span>, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>train_data_filtered <span class="ot">&lt;-</span> train_data[,selected_vars]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>test_data_filtered <span class="ot">&lt;-</span> test_data[,selected_vars]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>No issue with the variables selected except no date or stock variable?</p>
<p>#Convert necessary columns to numeric</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>train_data_filtered <span class="ot">&lt;-</span> train_data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(open, high, low, close), <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"[$,]"</span>, <span class="st">""</span>, .))))  <span class="co"># Clean and convert</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>test_data_filtered <span class="ot">&lt;-</span> test_data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(open, high, low, close), <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"[$,]"</span>, <span class="st">""</span>, .)))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#impute missing values using KNN in order to maintain integrity of any data patterns</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># KNN imputation on the training data</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>train_data_imputed <span class="ot">&lt;-</span> <span class="fu">kNN</span>(train_data_filtered, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"percent_change_volume_over_last_wk"</span>, <span class="st">"previous_weeks_volume"</span>), </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">k =</span> <span class="dv">5</span>, <span class="at">imp_var =</span> F)  <span class="co"># Adjust k (number of neighbors) as necessary</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Should return 'FALSE' if no missing values</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(train_data_imputed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>Variables were selected before but here you went back to your original un-selected training dataset. Adjusted to go with the datset with variable selections. I’m pretty neutral on imputing the data, my only concern here is that we may need to explain reasoning for choosing KNN imputation, and check assumptions for using this method. My original gut check with this is too assume the same volume change, so percent_change_over_last_week would be zero for imputed values, and previous_weeks_volume would equal volume.</p>
<p>#Apply scaling in prep for modeling</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>normalize_min_max <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  (x <span class="sc">-</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">/</span> (<span class="fu">max</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="ot">&lt;-</span> train_data_imputed <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), normalize_min_max))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="ot">&lt;-</span> test_data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), normalize_min_max))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#Chage Date variable to true date</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="ot">&lt;-</span> train_data_scaled <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">parse_date_time</span>(date, <span class="st">'%m/%d/%Y'</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="ot">&lt;-</span> test_data_scaled <span class="sc">%&gt;%</span> </span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">parse_date_time</span>(date, <span class="st">'%m/%d/%Y'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#Create lagged Variables on scaled data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span>  </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_change_price_lag1 =</span> <span class="fu">lag</span>(percent_change_price) </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date stock percent_change_next_weeks_price percent_change_price
1 2011-01-07    AA                       0.4770919            0.8338412
2 2011-01-07   AXP                       0.8705239            0.7754923
3 2011-01-07    BA                       0.7098931            0.8811481
4 2011-01-07   BAC                       1.0000000            0.7945878
5 2011-01-07   CAT                       0.7065060            0.6393762
6 2011-01-07  CSCO                       0.7252142            0.7796038
  percent_change_volume_over_last_wk previous_weeks_volume
1                         0.08825424            0.08475325
2                         0.06807195            0.02822541
3                         0.08777741            0.01771123
4                         0.15240536            0.67354126
5                         0.23260218            0.01243852
6                         0.03435266            0.20297610
  days_to_next_dividend percent_return_next_dividend        open        high
1            0.07738095                  0.078157861 0.014022729 0.016286645
2            0.26488095                  0.227004526 0.196650495 0.204429967
3            0.09821429                  0.360186281 0.348508008 0.364039088
4            0.16071429                  0.003070525 0.000930418 0.003061889
5            0.03273810                  0.269484482 0.536120157 0.525016287
6            0.24107143                  0.147166604 0.044792982 0.044169381
          low       close percent_change_price_lag1
1 0.016415321 0.020330033                        NA
2 0.198785533 0.204752475                 0.8338412
3 0.351528093 0.369900990                 0.7754923
4 0.003202989 0.006006601                 0.8811481
5 0.527025224 0.530627063                 0.7945878
6 0.047110637 0.050363036                 0.6393762</code></pre>
</div>
</div>
<p>Previous method to lag variables does not account for the stock itself. So lag value when ordered by date will pull the values for same date across different stocks.</p>
<p>#Create lagged variables on scaled data version 2</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="ot">&lt;-</span> train_data_scaled <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span>  </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_change_price_lag1 =</span> <span class="fu">lag</span>(percent_change_price, <span class="at">n =</span> <span class="dv">1</span>) </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="ot">&lt;-</span> test_data_scaled <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span>  </span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_change_price_lag1 =</span> <span class="fu">lag</span>(percent_change_price, <span class="at">n =</span> <span class="dv">1</span>) </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Group by should solve earlier issue</p>
<p>#Plotting the lagged variables to visualize correlation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(train_data_scaled, <span class="fu">aes</span>(<span class="at">x =</span> percent_change_price_lag1, <span class="at">y =</span> percent_change_price)) <span class="sc">+</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Lagged Variable Plot: Percentage Change in Price (t) vs (t-1)"</span>,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Percentage Change in Price (t-1)"</span>,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percentage Change in Price (t)"</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 30 rows containing non-finite outside the scale range
(`stat_smooth()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 30 rows containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>#Now applying data subset variables to a regression tree, our target variable is [percent_change_next_weeks_price] so we’re going to use this regression tree to assess our features importance (which ones are most predictive?)</p>
<p>#wrapper outside of tree model/use for loop == stock name/store rmse/mape into frame</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>tree_model <span class="ot">&lt;-</span> <span class="fu">rpart</span>(percent_change_next_weeks_price <span class="sc">~</span> ., <span class="at">data =</span> train_data_scaled, <span class="at">method =</span> <span class="st">"anova"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(tree_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>n= 360 

node), split, n, deviance, yval
      * denotes terminal node

 1) root 360 4.21490000 0.6817216  
   2) stock=BAC,CSCO,HPQ,INTC,JNJ,MRK,MSFT,PG 96 1.58025500 0.6399035  
     4) percent_change_price_lag1&gt;=0.617556 66 1.30698900 0.6248981  
       8) open&lt; 0.04828205 14 0.60864620 0.5572203 *
       9) open&gt;=0.04828205 52 0.61695460 0.6431190  
        18) date&gt;=1.297685e+09 21 0.27388060 0.6080194  
          36) stock=HPQ,INTC,MSFT 10 0.14957850 0.5486815 *
          37) stock=JNJ,MRK,PG 11 0.05708331 0.6619629 *
        19) date&lt; 1.297685e+09 31 0.29967630 0.6668962  
          38) stock=CSCO,JNJ,MRK,MSFT,PG 21 0.17238390 0.6353517 *
          39) stock=HPQ,INTC 10 0.06251427 0.7331397 *
     5) percent_change_price_lag1&lt; 0.617556 30 0.22571160 0.6729155  
      10) percent_return_next_dividend&gt;=0.1674097 22 0.09244524 0.6480928 *
      11) percent_return_next_dividend&lt; 0.1674097 8 0.08243244 0.7411781 *
   3) stock=AA,AXP,BA,CAT,CVX,DD,DIS,GE,HD,IBM,JPM,KO,KRFT,MCD,MMM,PFE,T,TRV,UTX,VZ,WMT,XOM 264 2.40571700 0.6969282  
     6) date&gt;=1.297685e+09 132 1.07594300 0.6729449  
      12) date&lt; 1.300104e+09 88 0.58674680 0.6381490  
        24) stock=AA,AXP,BA,CAT,DD,DIS,GE,HD,IBM,JPM,MCD,MMM,T,TRV,UTX,VZ,WMT,XOM 72 0.34759400 0.6242699  
          48) percent_change_price&gt;=0.5845257 59 0.26650510 0.6107899  
            96) stock=AA,CAT,DD,GE,HD,MCD,MMM,UTX,WMT,XOM 29 0.12307860 0.5828548 *
            97) stock=AXP,BA,DIS,IBM,JPM,T,TRV,VZ 30 0.09891940 0.6377939 *
          49) percent_change_price&lt; 0.5845257 13 0.02171200 0.6854481 *
        25) stock=CVX,KO,KRFT,PFE 16 0.16287160 0.7006049 *
      13) date&gt;=1.300104e+09 44 0.16955660 0.7425367  
        26) stock=AXP,DD,DIS,GE,HD,JPM,KRFT,MCD,MMM,PFE,TRV,WMT,XOM 26 0.06658794 0.7146048 *
        27) stock=AA,BA,CAT,CVX,IBM,KO,T,UTX,VZ 18 0.05338311 0.7828828 *
     7) date&lt; 1.297685e+09 132 1.17792100 0.7209116  
      14) stock=AA,AXP,BA,KO,KRFT,MCD,PFE,T,VZ,WMT 60 0.56579300 0.6850891  
        28) days_to_next_dividend&gt;=0.03869048 52 0.40438130 0.6703832  
          56) percent_return_next_dividend&lt; 0.2221778 7 0.04577601 0.5822318 *
          57) percent_return_next_dividend&gt;=0.2221778 45 0.29574920 0.6840957 *
        29) days_to_next_dividend&lt; 0.03869048 8 0.07706945 0.7806772 *
      15) stock=CAT,CVX,DD,DIS,GE,HD,IBM,JPM,MMM,TRV,UTX,XOM 72 0.47097100 0.7507636  
        30) percent_change_price_lag1&gt;=0.6350354 64 0.38402190 0.7420894 *
        31) percent_change_price_lag1&lt; 0.6350354 8 0.04360967 0.8201574 *</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">printcp</span>(tree_model)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
rpart(formula = percent_change_next_weeks_price ~ ., data = train_data_scaled, 
    method = "anova")

Variables actually used in tree construction:
[1] date                         days_to_next_dividend       
[3] open                         percent_change_price        
[5] percent_change_price_lag1    percent_return_next_dividend
[7] stock                       

Root node error: 4.2149/360 = 0.011708

n= 360 

         CP nsplit rel error  xerror    xstd
1  0.055392      0   1.00000 1.00733 0.13675
2  0.033490      3   0.83382 0.92768 0.12891
3  0.020011      4   0.80033 1.07174 0.14363
4  0.018098      5   0.78032 1.08223 0.14315
5  0.015296      6   0.76222 1.10654 0.14376
6  0.014913      8   0.73163 1.12249 0.14392
7  0.014087      9   0.71672 1.11152 0.14351
8  0.013871     10   0.70263 1.12769 0.14442
9  0.012061     13   0.66102 1.14059 0.14418
10 0.011764     14   0.64896 1.20058 0.15080
11 0.010559     15   0.63719 1.21103 0.15075
12 0.010282     16   0.62663 1.23132 0.15137
13 0.010000     17   0.61635 1.22840 0.15077</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree_model, <span class="at">uniform =</span> <span class="cn">TRUE</span>, <span class="at">main =</span> <span class="st">"Regression Tree for Stock Price Prediction"</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(tree_model, <span class="at">use.n =</span> <span class="cn">TRUE</span>, <span class="at">all =</span> <span class="cn">TRUE</span>, <span class="at">cex =</span> <span class="fl">0.7</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>#this looks nuts, not sure what to change to make it better</p>
<p>#gonna try pruning, also using Dr.&nbsp;Roy methods for creating tree</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>lagtree <span class="ot">&lt;-</span> <span class="fu">tree</span>(percent_change_next_weeks_price <span class="sc">~</span> ., <span class="at">data =</span> train_data_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = train_data_scaled):
NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If needed, pruning can be performed by specifying the "best" argument </span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>cv.lag <span class="ot">&lt;-</span> <span class="fu">cv.tree</span>(lagtree)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>best_size <span class="ot">&lt;-</span> cv.lag<span class="sc">$</span>size[<span class="fu">which.min</span>(cv.lag<span class="sc">$</span>dev)]</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>prune.lag <span class="ot">&lt;-</span> <span class="fu">prune.tree</span>(lagtree, <span class="at">best =</span> best_size)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(prune.lag)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Length Class      Mode   
frame     5    data.frame list   
where   330    -none-     numeric
terms     3    terms      call   
call      3    -none-     call   
y       330    -none-     numeric
weights 330    -none-     numeric</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(best_size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions on the test data </span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>dtpreds <span class="ot">&lt;-</span> <span class="fu">predict</span>(lagtree, <span class="at">newdata =</span> test_data_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>testpreds <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">date =</span> test_data_scaled<span class="sc">$</span>date,</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stock =</span> test_data_scaled<span class="sc">$</span>stock,</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">response =</span> test_data_scaled<span class="sc">$</span>percent_change_next_weeks_price,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dt =</span> dtpreds)</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>mse_dt <span class="ot">=</span> <span class="fu">mean</span>((testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>dt)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>mae_dt <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>dt))</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>me_dt <span class="ot">=</span> <span class="fu">mean</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>dt)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>mape_dt <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>dt)<span class="sc">*</span><span class="dv">100</span><span class="sc">/</span>testpreds<span class="sc">$</span>response)</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>testperfs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">dt =</span> <span class="fu">c</span>(mse_dt, mae_dt, me_dt, mape_dt)</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>                        ) <span class="sc">%&gt;%</span> <span class="fu">t</span>()</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(testperfs) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'mse'</span>, <span class="st">'mae'</span>, <span class="st">'me'</span>, <span class="st">'mape'</span>)</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] ""</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(testperfs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mse       mae         me mape
dt 0.04968299 0.1930942 -0.1686207  Inf</code></pre>
</div>
</div>
<p>after pruning, best size given is 1, which likely means decision tree won’t work out well anyway. but opting for no pruning for preds, we can always change this</p>
<p>Mape will always be Inf because of zero values for response. Probably don’t even need to include it, but i have it anyway in case we need to talk about why we don’t have it.</p>
</section>
<section id="linear-model" class="level1">
<h1>Linear model</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>lmfit1 <span class="ot">&lt;-</span> <span class="fu">step</span>(<span class="fu">lm</span>(percent_change_next_weeks_price <span class="sc">~</span> . <span class="sc">-</span> percent_change_price_lag1, <span class="at">data =</span> <span class="fu">na.omit</span>(train_data_scaled)), <span class="at">method =</span> <span class="st">'both'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Start:  AIC=-1476.33
percent_change_next_weeks_price ~ (date + stock + percent_change_price + 
    percent_change_volume_over_last_wk + previous_weeks_volume + 
    days_to_next_dividend + percent_return_next_dividend + open + 
    high + low + close + percent_change_price_lag1) - percent_change_price_lag1

                                     Df Sum of Sq    RSS     AIC
- stock                              29   0.52702 3.4804 -1480.1
- date                                1   0.00000 2.9534 -1478.3
- previous_weeks_volume               1   0.00104 2.9544 -1478.2
- close                               1   0.00141 2.9548 -1478.2
- percent_change_volume_over_last_wk  1   0.00504 2.9584 -1477.8
- low                                 1   0.00743 2.9608 -1477.5
- percent_change_price                1   0.01436 2.9677 -1476.7
- percent_return_next_dividend        1   0.01771 2.9711 -1476.3
&lt;none&gt;                                            2.9534 -1476.3
- high                                1   0.02980 2.9832 -1475.0
- open                                1   0.03125 2.9846 -1474.8
- days_to_next_dividend               1   0.04279 2.9962 -1473.6

Step:  AIC=-1480.14
percent_change_next_weeks_price ~ date + percent_change_price + 
    percent_change_volume_over_last_wk + previous_weeks_volume + 
    days_to_next_dividend + percent_return_next_dividend + open + 
    high + low + close

                                     Df Sum of Sq    RSS     AIC
- close                               1  0.000270 3.4807 -1482.1
- days_to_next_dividend               1  0.001016 3.4814 -1482.0
- percent_change_volume_over_last_wk  1  0.005272 3.4857 -1481.6
- date                                1  0.008586 3.4890 -1481.3
- percent_change_price                1  0.009021 3.4894 -1481.3
- low                                 1  0.014210 3.4946 -1480.8
- previous_weeks_volume               1  0.015808 3.4962 -1480.7
&lt;none&gt;                                            3.4804 -1480.1
- open                                1  0.023558 3.5039 -1479.9
- high                                1  0.049490 3.5299 -1477.5
- percent_return_next_dividend        1  0.053589 3.5340 -1477.1

Step:  AIC=-1482.12
percent_change_next_weeks_price ~ date + percent_change_price + 
    percent_change_volume_over_last_wk + previous_weeks_volume + 
    days_to_next_dividend + percent_return_next_dividend + open + 
    high + low

                                     Df Sum of Sq    RSS     AIC
- days_to_next_dividend               1  0.001025 3.4817 -1484.0
- percent_change_volume_over_last_wk  1  0.005458 3.4861 -1483.6
- date                                1  0.008370 3.4890 -1483.3
- percent_change_price                1  0.011180 3.4918 -1483.1
- previous_weeks_volume               1  0.015845 3.4965 -1482.6
- low                                 1  0.017976 3.4986 -1482.4
&lt;none&gt;                                            3.4807 -1482.1
- open                                1  0.023333 3.5040 -1481.9
- percent_return_next_dividend        1  0.053340 3.5340 -1479.1
- high                                1  0.075192 3.5559 -1477.1

Step:  AIC=-1484.02
percent_change_next_weeks_price ~ date + percent_change_price + 
    percent_change_volume_over_last_wk + previous_weeks_volume + 
    percent_return_next_dividend + open + high + low

                                     Df Sum of Sq    RSS     AIC
- percent_change_volume_over_last_wk  1  0.005286 3.4870 -1485.5
- date                                1  0.008680 3.4904 -1485.2
- percent_change_price                1  0.011739 3.4934 -1484.9
- previous_weeks_volume               1  0.015311 3.4970 -1484.6
- low                                 1  0.017281 3.4990 -1484.4
&lt;none&gt;                                            3.4817 -1484.0
- open                                1  0.023969 3.5057 -1483.8
- percent_return_next_dividend        1  0.052632 3.5343 -1481.1
- high                                1  0.074774 3.5565 -1479.0

Step:  AIC=-1485.52
percent_change_next_weeks_price ~ date + percent_change_price + 
    previous_weeks_volume + percent_return_next_dividend + open + 
    high + low

                               Df Sum of Sq    RSS     AIC
- date                          1  0.007495 3.4945 -1486.8
- percent_change_price          1  0.007767 3.4947 -1486.8
- previous_weeks_volume         1  0.012511 3.4995 -1486.3
- low                           1  0.013019 3.5000 -1486.3
- open                          1  0.020783 3.5078 -1485.6
&lt;none&gt;                                      3.4870 -1485.5
- percent_return_next_dividend  1  0.052272 3.5392 -1482.6
- high                          1  0.072769 3.5597 -1480.7

Step:  AIC=-1486.81
percent_change_next_weeks_price ~ percent_change_price + previous_weeks_volume + 
    percent_return_next_dividend + open + high + low

                               Df Sum of Sq    RSS     AIC
- percent_change_price          1  0.008126 3.5026 -1488.0
- low                           1  0.009910 3.5044 -1487.9
- previous_weeks_volume         1  0.012522 3.5070 -1487.6
&lt;none&gt;                                      3.4945 -1486.8
- open                          1  0.025648 3.5201 -1486.4
- percent_return_next_dividend  1  0.051478 3.5459 -1484.0
- high                          1  0.073448 3.5679 -1482.0

Step:  AIC=-1488.04
percent_change_next_weeks_price ~ previous_weeks_volume + percent_return_next_dividend + 
    open + high + low

                               Df Sum of Sq    RSS     AIC
- previous_weeks_volume         1  0.012606 3.5152 -1488.9
- open                          1  0.018407 3.5210 -1488.3
&lt;none&gt;                                      3.5026 -1488.0
- low                           1  0.026378 3.5290 -1487.6
- percent_return_next_dividend  1  0.049864 3.5525 -1485.4
- high                          1  0.065420 3.5680 -1483.9

Step:  AIC=-1488.86
percent_change_next_weeks_price ~ percent_return_next_dividend + 
    open + high + low

                               Df Sum of Sq    RSS     AIC
- open                          1  0.017527 3.5327 -1489.2
&lt;none&gt;                                      3.5152 -1488.9
- low                           1  0.027585 3.5428 -1488.3
- high                          1  0.066410 3.5816 -1484.7
- percent_return_next_dividend  1  0.086604 3.6018 -1482.8

Step:  AIC=-1489.22
percent_change_next_weeks_price ~ percent_return_next_dividend + 
    high + low

                               Df Sum of Sq    RSS     AIC
&lt;none&gt;                                      3.5327 -1489.2
- low                           1  0.046444 3.5792 -1486.9
- high                          1  0.050043 3.5828 -1486.6
- percent_return_next_dividend  1  0.081289 3.6140 -1483.7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lmfit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = percent_change_next_weeks_price ~ percent_return_next_dividend + 
    high + low, data = na.omit(train_data_scaled))

Residuals:
     Min       1Q   Median       3Q      Max 
-0.64864 -0.06253  0.00166  0.05809  0.29339 

Coefficients:
                             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                   0.63122    0.01543  40.917   &lt;2e-16 ***
percent_return_next_dividend  0.07561    0.02761   2.739   0.0065 ** 
high                          1.96449    0.91417   2.149   0.0324 *  
low                          -1.91623    0.92561  -2.070   0.0392 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.1041 on 326 degrees of freedom
Multiple R-squared:  0.04498,   Adjusted R-squared:  0.03619 
F-statistic: 5.118 on 3 and 326 DF,  p-value: 0.001795</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>lmpreds <span class="ot">&lt;-</span> <span class="fu">predict</span>(lmfit1, test_data_scaled)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>testpreds<span class="sc">$</span>lm <span class="ot">&lt;-</span> lmpreds</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>mse_lm <span class="ot">=</span> <span class="fu">mean</span>((testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>lm)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>mae_lm <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>lm))</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>me_lm <span class="ot">=</span> <span class="fu">mean</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>lm)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>mape_lm <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>lm)<span class="sc">*</span><span class="dv">100</span><span class="sc">/</span>testpreds<span class="sc">$</span>response)</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>testperfs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(testperfs, <span class="at">lm =</span> <span class="fu">c</span>(mse_lm, mae_lm, me_lm, mape_lm))</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(testperfs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mse       mae         me mape
dt 0.04968299 0.1930942 -0.1686207  Inf
lm 0.04333632 0.1796067 -0.1556633  Inf</code></pre>
</div>
</div>
<p>I had issues with missing values from the lag variable, so may need to bring this up to the professor later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lmfit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-19-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-19-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="svr" class="level1">
<h1>SVR</h1>
<p>SVR is omitting the rows with the NA for percent_change_price_lag1, so removing that variable here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="ot">&lt;-</span> train_data_scaled[ , <span class="fu">names</span>(train_data_scaled) <span class="sc">!=</span> <span class="st">'percent_change_price_lag1'</span>]</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="ot">&lt;-</span> test_data_scaled[ , <span class="fu">names</span>(test_data_scaled) <span class="sc">!=</span> <span class="st">'percent_change_price_lag1'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "AA"   "AXP"  "BA"   "BAC"  "CAT"  "CSCO" "CVX"  "DD"   "DIS"  "GE"  
[11] "HD"   "HPQ"  "IBM"  "INTC" "JNJ"  "JPM"  "KRFT" "KO"   "MCD"  "MMM" 
[21] "MRK"  "MSFT" "PFE"  "PG"   "T"    "TRV"  "UTX"  "VZ"   "WMT"  "XOM" </code></pre>
</div>
</div>
<p>Getting idea of parameters without for loop since it wouldn’t behave on its own. This was primarily just research and does need to be repeated for other models.</p>
<pre><code>form1 &lt;- percent_change_next_weeks_price ~ . - percent_change_price_lag1

svr_tune_lists &lt;- list() 
best_Params_list &lt;- list()

set.seed(123)
svr_tune_lists[['AA']] &lt;- tune.svm(form1, data = filter(train_data_scaled, stock == 'AA')[, names(train_data_scaled) != 'stock'],
                                   gamma = seq(.01,.1, by = .01), cost = seq(2.2, 2.5, by = .01), scale = T
                                   )
print(svr_tune_lists[['AA']])

set.seed(123)
svr_tune_lists[['AXP']] &lt;- tune.svm(form1, data = filter(train_data_scaled, stock == 'AXP')[, names(train_data_scaled) != 'stock'],
                                   gamma = seq(.001,.01, by = .001), cost = seq(9, 10, by = .05), scale = T
                                   )
print(svr_tune_lists[['AXP']])

set.seed(123)
svr_tune_lists[['BA']] &lt;- tune.svm(form1, data = filter(train_data_scaled, stock == 'BA')[, names(train_data_scaled) != 'stock'],
                                   gamma = seq(.01,.1, by = .01), cost = seq(1.5, 2.5, by = .1), scale = T
                                   )
print(svr_tune_lists[['BA']])

set.seed(123)
svr_tune_lists[['BA']] &lt;- tune.svm(form1, data = filter(train_data_scaled, stock == 'BA')[, names(train_data_scaled) != 'stock'],
                                   gamma = seq(.01,.1, by = .01), cost = seq(1.5, 2.5, by = .1), scale = T
                                   )
print(svr_tune_lists[['BA']])</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>form1 <span class="ot">&lt;-</span> percent_change_next_weeks_price <span class="sc">~</span> .</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>svr_tune_lists <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># initiate models list</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>best_Params_list <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># initiate list of best parameters for SVR for each stock</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock))) {</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  svr_tune_lists[[i]] <span class="ot">&lt;-</span>  <span class="fu">tune.svm</span>(form1, <span class="at">data =</span> <span class="fu">filter</span>(train_data_scaled, stock <span class="sc">==</span> i)[, <span class="fu">names</span>(train_data_scaled) <span class="sc">!=</span> <span class="st">'stock'</span>],</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">gamma =</span> <span class="fu">seq</span>(.<span class="dv">005</span>,.<span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">005</span>), <span class="at">cost =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">1</span>), <span class="at">scale =</span> T</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>                                   )</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>  best_Params_list[[i]] <span class="ot">&lt;-</span> svr_tune_lists[[i]]<span class="sc">$</span>best.parameters</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>checks for any models that did not predict because of bad tuning parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock))) {</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">is.na</span>(best_Params_list[[i]]<span class="sc">$</span>gamma))</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is the part to copy for the other models</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>svr_fit_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock))) {</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>  svr_fit_list[[i]] <span class="ot">&lt;-</span>  <span class="fu">svm</span>(form1, <span class="at">data =</span> <span class="fu">filter</span>(train_data_scaled, stock <span class="sc">==</span> i)[, <span class="fu">names</span>(train_data_scaled) <span class="sc">!=</span> <span class="st">'stock'</span>],</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">gamma =</span> best_Params_list[[i]]<span class="sc">$</span>gamma, <span class="at">cost =</span> best_Params_list[[i]]<span class="sc">$</span>cost, <span class="at">scale =</span> T</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>                                   )</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>this is used to print the summary of each model. Useful if you want to look, but the output is huge and blows up the view a bit.</p>
<pre><code>for (i in c(unique(train_data_scaled$stock))) {
    print(summary(svr_fit_list[[i]]))
}
</code></pre>
<p>stores predictions and other identifying variables into a list of dataframes. This is flattened later into one dataframeb, but must start as a list in order to more easily iterate through the stocks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>newpreds <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock))) {</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  newpreds[[i]] <span class="ot">&lt;-</span> test_data_scaled <span class="sc">%&gt;%</span> <span class="fu">filter</span>(stock <span class="sc">==</span> i) <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, stock, percent_change_next_weeks_price) <span class="co"># first model needs this line, all others can skip</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  newpreds[[i]]<span class="sc">$</span>svr <span class="ot">&lt;-</span> <span class="fu">predict</span>(svr_fit_list[[i]], <span class="fu">filter</span>(test_data_scaled, stock <span class="sc">==</span> i)[, <span class="fu">names</span>(test_data_scaled) <span class="sc">!=</span> <span class="st">'stock'</span>])</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>we do this step only once we have all predictions for all models saved to the list like we do above</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>predsdf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(newpreds, <span class="at">.id =</span> <span class="st">"column_label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>gets MSE for just SVR for now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>predsdf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span> </span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">SVR =</span> <span class="fu">mean</span>((<span class="fu">na.omit</span>(percent_change_next_weeks_price) <span class="sc">-</span> svr)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 2
   stock    SVR
   &lt;chr&gt;  &lt;dbl&gt;
 1 AA    0.0549
 2 AXP   0.0278
 3 BA    0.0627
 4 BAC   0.0248
 5 CAT   0.172 
 6 CSCO  0.0432
 7 CVX   0.0898
 8 DD    0.0491
 9 DIS   0.0933
10 GE    0.0617
# ℹ 20 more rows</code></pre>
</div>
</div>
<p>Overall MSE</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>predsdf <span class="sc">%&gt;%</span> </span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">SVR =</span> <span class="fu">mean</span>((<span class="fu">na.omit</span>(percent_change_next_weeks_price) <span class="sc">-</span> svr)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
     SVR
   &lt;dbl&gt;
1 0.0484</code></pre>
</div>
</div>
<p>Questions for Dr.&nbsp;Roy: 1. Create Lag variable before or after test train split? Same for lag plots? Creates loss of observations in test when done after. create after, don’t want training data in your test dataset 2. Group by for lag variable calculation? yes 3. Lag variable keeps getting eliminated in step function for lm, should it be? Since we are using percent instead of one of the open or close prices, lag is pretty useless. 4. KNN imputation appropriate for missing values? yes 5. Tree pruning returns 1 node? didn’t get to this question, but may be very different once we start fitting models the right way for dt anyway.</p>
</section>
<section id="picking-up-where-will-left-off-from-here.-this-part-adds-for-lm---holly" class="level1">
<h1>PICKING UP WHERE WILL LEFT OFF FROM HERE. THIS PART ADDS FOR LM - HOLLY</h1>
<p>#Have to define the formula when using LM since it doesn’t perform the same as SVR when it comes to feature selection</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the formula for LM dynamically to use all existing variables except 'percent_change_next_weeks_price'</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>lm_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"percent_change_next_weeks_price ~ ."</span>))</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>lm_fit_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock)) {</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  stock_data <span class="ot">&lt;-</span> <span class="fu">filter</span>(train_data_scaled, stock <span class="sc">==</span> i) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>stock)</span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  lm_fit_list[[i]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(lm_formula, <span class="at">data =</span> stock_data)</span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#Adding my LM predictions to the ‘newpreds’ list</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(test_data_scaled<span class="sc">$</span>stock)) {</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  newpreds[[i]]<span class="sc">$</span>lm_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm_fit_list[[i]], <span class="at">newdata =</span> <span class="fu">filter</span>(test_data_scaled, stock <span class="sc">==</span> i))</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>combined_preds_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(newpreds, <span class="at">.id =</span> <span class="st">"stock"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="decision-trees" class="level1">
<h1>Decision Trees</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define formula for the decision tree model</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>tree_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"percent_change_next_weeks_price ~ ."</span>)</span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a list to store the decision tree fits for each stock</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>tree_fit_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each unique stock and fit a decision tree model</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(test_data_scaled<span class="sc">$</span>stock)) {</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter data for the current stock, excluding the 'stock' column</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">#stock_data_dt &lt;- filter(train_data_scaled_dt, stock == i) %&gt;% select(-stock)</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the decision tree model for the current stock</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>  tree_fit_list[[i]] <span class="ot">&lt;-</span> <span class="fu">tree</span>(tree_formula, <span class="at">data =</span> stock_data)</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion
Warning in tree(tree_formula, data = stock_data): NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Access the decision tree model for a specific stock, e.g., "AA"</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(tree_fit_list[[<span class="st">"AA"</span>]])  <span class="co"># Provides a summary of the tree for stock "AA"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
tree(formula = tree_formula, data = stock_data)
Variables actually used in tree construction:
[1] "close"
Number of terminal nodes:  2 
Residual mean deviance:  0.007199 = 0.07199 / 10 
Distribution of residuals:
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.148200 -0.033220  0.007472  0.000000  0.061980  0.097500 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(tree_fit_list[[<span class="st">"AA"</span>]])     <span class="co"># Plots the decision tree for stock "AA"</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(tree_fit_list[[<span class="st">"AA"</span>]], <span class="at">pretty =</span> <span class="dv">0</span>) <span class="co"># Adds text to the tree plot</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a list to store predictions</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>treepreds <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each unique stock and get predictions from the decision tree model</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(test_data_scaled<span class="sc">$</span>stock)) {</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make predictions using the decision tree model for the specific stock</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>  treepreds[[i]] <span class="ot">&lt;-</span> <span class="fu">filter</span>(test_data_scaled, stock <span class="sc">==</span> i)</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>  newpreds[[i]]<span class="sc">$</span>tree_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(tree_fit_list[[i]], <span class="at">newdata =</span> treepreds[[i]])</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion
Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all predictions into a single data frame</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>combined_preds_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(newpreds, <span class="at">.id =</span> <span class="st">"stock"</span>)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View the combined predictions</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(combined_preds_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 390 × 6
   date                stock percent_change_next_weeks…¹   svr lm_pred tree_pred
   &lt;dttm&gt;              &lt;chr&gt;                       &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
 1 2011-04-01 00:00:00 AA                         0.656  0.589    17.8     0.754
 2 2011-04-08 00:00:00 AA                         0.0967 0.611    17.7     0.754
 3 2011-04-15 00:00:00 AA                         0.698  0.562    19.5     0.754
 4 2011-04-21 00:00:00 AA                         0.532  0.633    17.3     0.754
 5 2011-04-29 00:00:00 AA                         0.481  0.585    18.3     0.754
 6 2011-05-06 00:00:00 AA                         0.498  0.593    19.0     0.754
 7 2011-05-13 00:00:00 AA                         0.302  0.621    18.0     0.754
 8 2011-05-20 00:00:00 AA                         0.675  0.567    19.7     0.754
 9 2011-05-27 00:00:00 AA                         0.278  0.623    18.0     0.754
10 2011-06-03 00:00:00 AA                         0.318  0.567    20.2     0.754
# ℹ 380 more rows
# ℹ abbreviated name: ¹​percent_change_next_weeks_price</code></pre>
</div>
</div>
<p>#Comparing what we have so far with LM, SVR, and Decision Trees using MSE/MAE/MAPE for each model and stock</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="ot">&lt;-</span> combined_preds_df <span class="sc">%&gt;%</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_LM =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((percent_change_next_weeks_price <span class="sc">-</span> lm_pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MAE_LM = mean(abs(percent_change_next_weeks_price - lm_pred), na.rm = TRUE),</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MAPE_LM = mean(abs(percent_change_next_weeks_price - lm_pred) * 100 / abs(percent_change_next_weeks_price), na.rm = TRUE),</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_SVR =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((percent_change_next_weeks_price <span class="sc">-</span> svr)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MAE_SVR = mean(abs(percent_change_next_weeks_price - svr), na.rm = TRUE),</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MAPE_SVR = mean(abs(percent_change_next_weeks_price - svr) * 100 / abs(percent_change_next_weeks_price), na.rm = TRUE),</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_Tree =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((percent_change_next_weeks_price <span class="sc">-</span> tree_pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MAE_Tree = mean(abs(percent_change_next_weeks_price - tree_pred), na.rm = TRUE),</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#MAPE_Tree = mean(abs(percent_change_next_weeks_price - tree_pred) * 100 / abs(percent_change_next_weeks_price), na.rm = TRUE)</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(performance_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 4
   stock RMSE_LM RMSE_SVR RMSE_Tree
   &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
 1 AA     18.8      0.234     0.335
 2 AXP    16.8      0.167     0.234
 3 BA      3.21     0.250     0.274
 4 BAC    29.2      0.157     0.330
 5 CAT     0.650    0.415     0.244
 6 CSCO    1.37     0.208     0.305
 7 CVX     2.91     0.300     0.192
 8 DD      5.07     0.222     0.279
 9 DIS     9.40     0.305     0.299
10 GE     11.0      0.248     0.294
# ℹ 20 more rows</code></pre>
</div>
</div>
<p>Isolated down to RMSE only to make it more consumable. Dr.&nbsp;Roy suggested RMSE or MAPE, MAPE would have problems with models where there is a value of 0 for the actual value.</p>
</section>
<section id="two-thought-processes-for-overall-rmse-taking-mean-across-stocks" class="level1">
<h1>Two thought processes for overall RMSE: taking mean across stocks</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="sc">%&gt;%</span> <span class="fu">summarize</span>(</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE_LM =</span> <span class="fu">mean</span>(RMSE_LM),</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE_SVR =</span> <span class="fu">mean</span>(RMSE_SVR),</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">RMSE_Tree =</span> <span class="fu">mean</span>(RMSE_Tree)</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  RMSE_LM RMSE_SVR RMSE_Tree
    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1    18.3    0.211     0.250</code></pre>
</div>
</div>
</section>
<section id="calculating-rmse-across-all-predictions-without-stock-groupings" class="level1">
<h1>calculating RMSE across all predictions without stock groupings</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>combined_preds_df <span class="sc">%&gt;%</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_LM =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((percent_change_next_weeks_price <span class="sc">-</span> lm_pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_SVR =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((percent_change_next_weeks_price <span class="sc">-</span> svr)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSE_Tree =</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((percent_change_next_weeks_price <span class="sc">-</span> tree_pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  RMSE_LM RMSE_SVR RMSE_Tree
    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
1    33.1    0.220     0.255</code></pre>
</div>
</div>
<p>#Interpretation of output: #LM does not seem to be performing well compared to SVR (this could be do to it not handling outliers well?).SVR Outperforms LM in MSE and MAE- has lower MSE and MAE values across most stocks, indicating it may have a better fit to the data than LM. For example, for stock AA, MSE_SVR is 0.0546 compared to MSE_LM of 353.17. This pattern holds for many stocks, showing SVR may be a better choice here.Additionally, MAPE values for LM are significantly higher than those for SVR in most cases, which suggests that SVR’s predictions are relatively closer to actual values as a percentage. Some of the MAPE values for LM are very large (like 5168.89 for AA), which might indicate that LM struggles with certain stocks, potentially due to variability or outliers in the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting Actual vs. Predicted for LM and SVR</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_preds_df, <span class="fu">aes</span>(<span class="at">x =</span> percent_change_next_weeks_price)) <span class="sc">+</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> lm_pred, <span class="at">color =</span> <span class="st">"LM"</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> svr, <span class="at">color =</span> <span class="st">"SVR"</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> tree_pred, <span class="at">color =</span> <span class="st">"Tree"</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Actual vs Predicted Values for LM, SVR, and Decision Trees"</span>,</span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Percent Change Next Week's Price"</span>,</span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Percent Change Next Week's Price"</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> stock) <span class="sc">+</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Model"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"LM"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"SVR"</span> <span class="ot">=</span> <span class="st">"red"</span>, <span class="st">"Tree"</span> <span class="ot">=</span> <span class="st">'green'</span>)) <span class="sc">+</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-35-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Holly Comments/observations: Regression Tree and Pruning pruning resulting in only one node suggests that the tree might not capture much complexity in the data, possibly due to: Limited predictive strength of the features relative to the target This may be good to consider alternate models, as we will do with Linear Regression (LM) and SVR, to assess if these might capture the patterns better</p>
</section>
<section id="capm" class="level1">
<h1>CAPM</h1>
<p>data obtained from Yahoo finance <a href="https://finance.yahoo.com/quote/%5EGSPC/history/?period1=1294358400&amp;period2=1308873600&amp;frequency=1wk">here</a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>SP500_raw</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Date     Open     High      Low   Close. Adj.Close.         Volume
1  20-Jun-11 1,271.50 1,298.61 1,262.87 1,283.50   1,283.50 16,222,680,000
2  13-Jun-11 1,271.31 1,292.50 1,258.07 1,271.50   1,271.50 20,466,010,000
3   6-Jun-11 1,300.26 1,300.26 1,268.28 1,270.98   1,270.98 18,551,800,000
4  30-May-11 1,331.10 1,345.20 1,297.90 1,300.16   1,300.16 16,204,530,000
5  23-May-11 1,333.07 1,334.62 1,311.80 1,331.10   1,331.10 17,595,530,000
6  16-May-11 1,334.77 1,346.82 1,318.51 1,333.27   1,333.27 19,514,380,000
7   9-May-11 1,340.20 1,359.44 1,332.03 1,337.77   1,337.77 19,539,110,000
8   2-May-11 1,365.21 1,370.58 1,329.17 1,340.20   1,340.20 20,363,720,000
9  25-Apr-11 1,337.14 1,364.56 1,331.47 1,363.61   1,363.61 17,617,650,000
10 18-Apr-11 1,313.35 1,337.49 1,294.70 1,337.38   1,337.38 15,933,560,000
11 11-Apr-11 1,329.01 1,333.77 1,302.42 1,319.68   1,319.68 19,701,690,000
12  4-Apr-11 1,333.56 1,339.46 1,322.94 1,328.17   1,328.17 19,888,170,000
13 28-Mar-11 1,315.45 1,337.85 1,305.26 1,332.41   1,332.41 18,297,330,000
14 21-Mar-11 1,281.65 1,319.18 1,281.65 1,313.80   1,313.80 20,090,110,000
15 14-Mar-11 1,301.19 1,301.19 1,249.05 1,279.21   1,279.21 23,905,220,000
16  7-Mar-11 1,322.72 1,327.68 1,291.99 1,304.28   1,304.28 20,669,090,000
17 28-Feb-11 1,321.61 1,332.28 1,302.58 1,321.15   1,321.15 12,022,480,000
18 21-Feb-11 1,338.91 1,338.91 1,294.26 1,319.88   1,319.88  7,712,050,000
19 14-Feb-11 1,328.73 1,344.07 1,324.61 1,343.01   1,343.01 12,589,110,000
20  7-Feb-11 1,311.85 1,330.79 1,311.74 1,329.15   1,329.15 20,109,950,000
21 31-Jan-11 1,276.50 1,311.00 1,276.50 1,310.87   1,310.87 21,726,860,000
22 24-Jan-11 1,283.29 1,302.67 1,275.10 1,276.34   1,276.34 23,156,650,000
23 17-Jan-11 1,293.22 1,296.06 1,271.26 1,283.35   1,283.35 19,899,340,000
24 10-Jan-11 1,270.84 1,293.24 1,262.18 1,293.24   1,293.24 21,286,570,000
25  3-Jan-11 1,276.29 1,278.17 1,261.70 1,271.50   1,271.50  9,807,210,000</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>SP500 <span class="ot">&lt;-</span> SP500_raw <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">Date =</span> <span class="fu">parse_date_time</span>(Date, <span class="st">'%d-%b-%y'</span>),</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">Date =</span> Date <span class="sc">+</span> <span class="fu">days</span>(<span class="dv">4</span>)</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">mutate_at</span>(</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>  <span class="dv">2</span><span class="sc">:</span><span class="dv">7</span>, parse_number</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">percent_change =</span> (Close. <span class="sc">-</span> Open)<span class="sc">/</span>Open</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> <span class="fu">select</span>(Date, percent_change)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Example for calculation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>train_data_filtered <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">pct =</span> (close<span class="sc">-</span>open)<span class="sc">/</span>open) <span class="sc">%&gt;%</span> <span class="fu">select</span>(pct, percent_change_price) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           pct percent_change_price
1  0.037926675             3.792670
2 -0.044284859            -4.428490
3 -0.024706609            -2.470660
4  0.016383113             1.638310
5  0.059332509             5.933250
6  0.002308136             0.230814</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>risk_data <span class="ot">&lt;-</span> raw_index_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, stock, percent_change_price) <span class="sc">%&gt;%</span> </span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">parse_date_time</span>(date, <span class="st">'%m/%d/%Y'</span>),</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_change_price =</span> percent_change_price<span class="sc">/</span><span class="dv">100</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a>rd_joined <span class="ot">&lt;-</span> <span class="fu">left_join</span>(risk_data, SP500, <span class="fu">join_by</span>(date <span class="sc">==</span> Date))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>risk_fit_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(rd_joined<span class="sc">$</span>stock)) {</span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>  stock_risk <span class="ot">&lt;-</span> <span class="fu">filter</span>(rd_joined, stock <span class="sc">==</span> i)</span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>  risk_fit_list[[i]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(percent_change_price <span class="sc">~</span> percent_change, <span class="at">data =</span> stock_risk)</span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a>stock_betas <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(rd_joined<span class="sc">$</span>stock)) {</span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>  stock_betas[[i]] <span class="ot">&lt;-</span> <span class="fu">summary</span>(risk_fit_list[[i]])<span class="sc">$</span>coefficients[<span class="dv">2</span>, <span class="dv">1</span>] <span class="sc">%&gt;%</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>betas_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(stock_betas, <span class="at">.id =</span> <span class="st">'stock'</span>)</span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(betas_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'stock'</span>, <span class="st">'betas'</span>)</span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(betas_df)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   stock     betas
1     AA 1.1725304
2    AXP 0.8412370
3     BA 1.1128029
4    BAC 0.8543340
5    CAT 1.6339876
6   CSCO 0.6728097
7    CVX 0.9576598
8     DD 1.3818514
9    DIS 1.2379936
10    GE 0.8723050
11    HD 1.0236042
12   HPQ 0.9324046
13   IBM 0.7556635
14  INTC 0.9967677
15   JNJ 0.5137296
16   JPM 0.6997650
17  KRFT 0.2728910
18    KO 0.5902203
19   MCD 0.5584826
20   MMM 0.9663208
21   MRK 0.2065984
22  MSFT 0.5429847
23   PFE 0.7351774
24    PG 0.2777192
25     T 0.6540860
26   TRV 0.9439450
27   UTX 0.8619338
28    VZ 0.6654782
29   WMT 0.4540274
30   XOM 1.1133388</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>Jul1_preds <span class="ot">&lt;-</span> combined_preds_df <span class="sc">%&gt;%</span> <span class="fu">filter</span>(date <span class="sc">==</span> <span class="fu">max</span>(date)) <span class="sc">%&gt;%</span> <span class="fu">select</span>(stock, percent_change_next_weeks_price, svr)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>risk_pred <span class="ot">&lt;-</span> Jul1_preds <span class="sc">%&gt;%</span> <span class="fu">left_join</span>(betas_df, <span class="fu">join_by</span>(stock))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>risk_pred data frame can be used for the visualization. If for any reason we decide to pick a different model after additional changes or tuning, we can select a different column in chunk above. I haven’t looked too much into picking the best stock, I figure once we have the visualization it will be easier to make that decision. Also, our price predictions and original measurements may not be as interpretable since we normalized the data. For example, stock AA isn’t predicted to see a percent change of 0.696 in the next week. SVR still generally needs centering and scaling to work properly, so not sure yet how we unwind this, but just a word of caution for when we give our write up.</p>
<p>#Holly adding Visuals here…..(it will not hurt my feelings if these get deleted or changed)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(risk_pred, <span class="fu">aes</span>(<span class="at">x =</span> betas, <span class="at">y =</span> svr)) <span class="sc">+</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Scatter Plot of Predicted Percent Change vs. Betas"</span>,</span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Betas"</span>,</span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Percent Change for Next Week"</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>()</span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-44-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>#Hopefully put the right variables on the right axis.. WH: Axes look right, percent change is like a function of the risk value, which is represent by Beta. Chart below is a good idea, adding the label. HD looks like good return with only moderate risk, since the value is just above 1 for Beta, it means it is theoretically only slightly more volatile than the market. CVX has the best return while still being less volatile, so depending on what sort of risk a person’s stock portfolio is willing to accept that may be the better choice.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(risk_pred, <span class="fu">aes</span>(<span class="at">x =</span> betas, <span class="at">y =</span> svr, <span class="at">label =</span> stock)) <span class="sc">+</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="at">vjust =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">hjust =</span> <span class="dv">1</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Risk-Return Trade-Off by Stock"</span>,</span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Betas"</span>,</span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Percent Change for Next Week"</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-45-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>#Not at all sure if I’m right about comparing these two fields from risk_pred but I saw we have a prediction for next week and an SVR prediction? Just comparing the two… WH: percent_change_next_week is the actual value for the week’s percent change, not a prediction. In practice we wouldn’t have that, but since we are making this model we do have the benefit of hindsight and can see if we got it right. I’ve changed those across the charts to make sure we are using the SVR prediction instead of the actual value.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(risk_pred, <span class="fu">aes</span>(<span class="at">x =</span> stock)) <span class="sc">+</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">y =</span> percent_change_next_weeks_price, <span class="at">fill =</span> <span class="st">"Actual"</span>), <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>) <span class="sc">+</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(<span class="at">y =</span> svr, <span class="at">fill =</span> <span class="st">"SVR"</span>), <span class="at">stat =</span> <span class="st">"identity"</span>, <span class="at">position =</span> <span class="st">"dodge"</span>, <span class="at">alpha =</span> <span class="fl">0.8</span>) <span class="sc">+</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Comparison of Actual Percent Change and SVR by Stock"</span>,</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Stock"</span>,</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percent Change"</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"Actual"</span> <span class="ot">=</span> <span class="st">"dodgerblue"</span>, <span class="st">"SVR"</span> <span class="ot">=</span> <span class="st">"orange"</span>)) <span class="sc">+</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">45</span>, <span class="at">hjust =</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_WH_files/figure-html/unnamed-chunk-46-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>This chart highlights what the actual vs predicted relationship would be, i.e.&nbsp;tells us if we pick one stock, are we right about it? We can HD has a slightly lower percent change than we expected, and that CVX is actually slightly higher. This kind of puts me even more back to a mind set about the normalization. We know which ones might be the best stocks, but we have two relatively good options and we don’t know if one of them might even have negative return. If it does, and if we predict as such, we would likely make different choices about what stock. I’m actually wondering if it would be possible for us to “unwind” the normalization algebraically. Basically solving for the original value from the normalization formula from earlier. I’ll have to think more about that.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>