<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Case Study 3 Sandbox</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="CS3_Sandbox_TH_files/libs/clipboard/clipboard.min.js"></script>
<script src="CS3_Sandbox_TH_files/libs/quarto-html/quarto.js"></script>
<script src="CS3_Sandbox_TH_files/libs/quarto-html/popper.min.js"></script>
<script src="CS3_Sandbox_TH_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="CS3_Sandbox_TH_files/libs/quarto-html/anchor.min.js"></script>
<link href="CS3_Sandbox_TH_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="CS3_Sandbox_TH_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="CS3_Sandbox_TH_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="CS3_Sandbox_TH_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="CS3_Sandbox_TH_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Case Study 3 Sandbox</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="case-study-3-sandbox" class="level2">
<h2 class="anchored" data-anchor-id="case-study-3-sandbox">Case Study 3 Sandbox</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(MASS, tidyverse, here, skimr, rpart, dplyr, VIM, corrplot, car, quantmod, ggplot2, tree, e1071)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>select <span class="ot">&lt;-</span> dplyr<span class="sc">::</span>select</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>raw_index_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">'Case Study 3'</span>, <span class="st">'dow_jones_index.data'</span>))</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>raw_index_names <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">here</span>(<span class="st">'Case Study 3'</span>, <span class="st">'dow_jones_index.names'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">str</span>(raw_index_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>'data.frame':   750 obs. of  16 variables:
 $ quarter                           : int  1 1 1 1 1 1 1 1 1 1 ...
 $ stock                             : chr  "AA" "AA" "AA" "AA" ...
 $ date                              : chr  "1/7/2011" "1/14/2011" "1/21/2011" "1/28/2011" ...
 $ open                              : chr  "$15.82" "$16.71" "$16.19" "$15.87" ...
 $ high                              : chr  "$16.72" "$16.71" "$16.38" "$16.63" ...
 $ low                               : chr  "$15.78" "$15.64" "$15.60" "$15.82" ...
 $ close                             : chr  "$16.42" "$15.97" "$15.79" "$16.13" ...
 $ volume                            : int  239655616 242963398 138428495 151379173 154387761 114691279 80023895 132981863 109493077 114332562 ...
 $ percent_change_price              : num  3.79 -4.43 -2.47 1.64 5.93 ...
 $ percent_change_volume_over_last_wk: num  NA 1.38 -43.02 9.36 1.99 ...
 $ previous_weeks_volume             : int  NA 239655616 242963398 138428495 151379173 154387761 114691279 80023895 132981863 109493077 ...
 $ next_weeks_open                   : chr  "$16.71" "$16.19" "$15.87" "$16.18" ...
 $ next_weeks_close                  : chr  "$15.97" "$15.79" "$16.13" "$17.14" ...
 $ percent_change_next_weeks_price   : num  -4.428 -2.471 1.638 5.933 0.231 ...
 $ days_to_next_dividend             : int  26 19 12 5 97 90 83 76 69 62 ...
 $ percent_return_next_dividend      : num  0.183 0.188 0.19 0.186 0.175 ...</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(raw_index_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">raw_index_data</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">750</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">16</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 22%">
<col style="width: 13%">
<col style="width: 18%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">stock</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">date</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">9</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">open</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">722</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">high</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">713</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">low</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">711</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">close</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">711</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">next_weeks_open</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">720</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">next_weeks_close</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">715</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 23%">
<col style="width: 6%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 3%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">quarter</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.52</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">2.000000e+00</td>
<td style="text-align: left;">▇▁▁▁▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">volume</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">117547801.41</td>
<td style="text-align: right;">158438089.36</td>
<td style="text-align: right;">9718851.00</td>
<td style="text-align: right;">30866243.25</td>
<td style="text-align: right;">53060885.00</td>
<td style="text-align: right;">132721823.75</td>
<td style="text-align: right;">1.453439e+09</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">percent_change_price</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">2.52</td>
<td style="text-align: right;">-15.42</td>
<td style="text-align: right;">-1.29</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.65</td>
<td style="text-align: right;">9.880000e+00</td>
<td style="text-align: left;">▁▁▆▇▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">percent_change_volume_over_last_wk</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">5.59</td>
<td style="text-align: right;">40.54</td>
<td style="text-align: right;">-61.43</td>
<td style="text-align: right;">-19.80</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">21.80</td>
<td style="text-align: right;">3.274100e+02</td>
<td style="text-align: left;">▇▃▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">previous_weeks_volume</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">117387644.83</td>
<td style="text-align: right;">159232228.00</td>
<td style="text-align: right;">9718851.00</td>
<td style="text-align: right;">30678320.00</td>
<td style="text-align: right;">52945558.00</td>
<td style="text-align: right;">133322975.25</td>
<td style="text-align: right;">1.453439e+09</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">percent_change_next_weeks_price</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">2.68</td>
<td style="text-align: right;">-15.42</td>
<td style="text-align: right;">-1.22</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">1.85</td>
<td style="text-align: right;">9.880000e+00</td>
<td style="text-align: left;">▁▁▆▇▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">days_to_next_dividend</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">52.53</td>
<td style="text-align: right;">46.34</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">24.00</td>
<td style="text-align: right;">47.00</td>
<td style="text-align: right;">69.00</td>
<td style="text-align: right;">3.360000e+02</td>
<td style="text-align: left;">▇▃▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">percent_return_next_dividend</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.69</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">0.53</td>
<td style="text-align: right;">0.68</td>
<td style="text-align: right;">0.85</td>
<td style="text-align: right;">1.560000e+00</td>
<td style="text-align: left;">▃▇▇▂▂</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(raw_index_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>#It appears we have missing values, We will need to address this in some of our next steps but first we’ll divide the data into train and test</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>missing_values <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="fu">is.na</span>(raw_index_data))</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>missing_values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                           quarter                              stock 
                                 0                                  0 
                              date                               open 
                                 0                                  0 
                              high                                low 
                                 0                                  0 
                             close                             volume 
                                 0                                  0 
              percent_change_price percent_change_volume_over_last_wk 
                                 0                                 30 
             previous_weeks_volume                    next_weeks_open 
                                30                                  0 
                  next_weeks_close    percent_change_next_weeks_price 
                                 0                                  0 
             days_to_next_dividend       percent_return_next_dividend 
                                 0                                  0 </code></pre>
</div>
</div>
<p>#Splitting data into training (Q1) and testing (Q2)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">subset</span>(raw_index_data, quarter <span class="sc">==</span> <span class="dv">1</span>)  <span class="co"># Training data (Q1: Jan-Mar)</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">subset</span>(raw_index_data, quarter <span class="sc">==</span> <span class="dv">2</span>)   <span class="co"># Testing data (Q2: Apr-Jun)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#Running correlation check among the numeric variables</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>cor_matrix <span class="ot">&lt;-</span> <span class="fu">cor</span>(train_data[, <span class="fu">sapply</span>(train_data, is.numeric)], <span class="at">use =</span> <span class="st">"complete.obs"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in cor(train_data[, sapply(train_data, is.numeric)], use =
"complete.obs"): the standard deviation is zero</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>cor_matrix</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                   quarter      volume percent_change_price
quarter                                  1          NA                   NA
volume                                  NA  1.00000000         -0.221694454
percent_change_price                    NA -0.22169445          1.000000000
percent_change_volume_over_last_wk      NA  0.19768437         -0.358896850
previous_weeks_volume                   NA  0.86432993         -0.045258948
percent_change_next_weeks_price         NA -0.13167362          0.010374354
days_to_next_dividend                   NA -0.06414402          0.035086236
percent_return_next_dividend            NA -0.27603768         -0.005173395
                                   percent_change_volume_over_last_wk
quarter                                                            NA
volume                                                     0.19768437
percent_change_price                                      -0.35889685
percent_change_volume_over_last_wk                         1.00000000
previous_weeks_volume                                     -0.14112278
percent_change_next_weeks_price                            0.04455945
days_to_next_dividend                                     -0.01836656
percent_return_next_dividend                              -0.01906340
                                   previous_weeks_volume
quarter                                               NA
volume                                        0.86432993
percent_change_price                         -0.04525895
percent_change_volume_over_last_wk           -0.14112278
previous_weeks_volume                         1.00000000
percent_change_next_weeks_price              -0.15477083
days_to_next_dividend                        -0.06300760
percent_return_next_dividend                 -0.27870205
                                   percent_change_next_weeks_price
quarter                                                         NA
volume                                                -0.131673616
percent_change_price                                   0.010374354
percent_change_volume_over_last_wk                     0.044559445
previous_weeks_volume                                 -0.154770828
percent_change_next_weeks_price                        1.000000000
days_to_next_dividend                                 -0.005275484
percent_return_next_dividend                           0.109565562
                                   days_to_next_dividend
quarter                                               NA
volume                                      -0.064144021
percent_change_price                         0.035086236
percent_change_volume_over_last_wk          -0.018366565
previous_weeks_volume                       -0.063007605
percent_change_next_weeks_price             -0.005275484
days_to_next_dividend                        1.000000000
percent_return_next_dividend                 0.100206077
                                   percent_return_next_dividend
quarter                                                      NA
volume                                             -0.276037679
percent_change_price                               -0.005173395
percent_change_volume_over_last_wk                 -0.019063402
previous_weeks_volume                              -0.278702047
percent_change_next_weeks_price                     0.109565562
days_to_next_dividend                               0.100206077
percent_return_next_dividend                        1.000000000</code></pre>
</div>
</div>
<p>#There appears to be correlation between ‘volume’ and keep ‘previous_weeks_volume’-these two had &gt;.8 (high correlation). Which one would be important to keep for predicting our target variable [percent_change_next_weeks_price]?</p>
<p>#I’ve decided to parse out the data variables I believe will be most useful moving forward</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>selected_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'date'</span>, <span class="st">'stock'</span>, <span class="st">"percent_change_next_weeks_price"</span>, <span class="st">"percent_change_price"</span>, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"percent_change_volume_over_last_wk"</span>, <span class="st">"previous_weeks_volume"</span>, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"days_to_next_dividend"</span>, <span class="st">"percent_return_next_dividend"</span>, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"open"</span>, <span class="st">"high"</span>, <span class="st">"low"</span>, <span class="st">"close"</span>)</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>train_data_filtered <span class="ot">&lt;-</span> train_data[,selected_vars]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>test_data_filtered <span class="ot">&lt;-</span> test_data[,selected_vars]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>No issue with the variables selected except no date or stock variable?</p>
<p>#Convert necessary columns to numeric</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>train_data_filtered <span class="ot">&lt;-</span> train_data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(open, high, low, close), <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"[$,]"</span>, <span class="st">""</span>, .))))  <span class="co"># Clean and convert</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>test_data_filtered <span class="ot">&lt;-</span> test_data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(open, high, low, close), <span class="sc">~</span> <span class="fu">as.numeric</span>(<span class="fu">gsub</span>(<span class="st">"[$,]"</span>, <span class="st">""</span>, .)))) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#impute missing values using KNN in order to maintain integrity of any data patterns</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># KNN imputation on the training data</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>train_data_imputed <span class="ot">&lt;-</span> <span class="fu">kNN</span>(train_data_filtered, <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"percent_change_volume_over_last_wk"</span>, <span class="st">"previous_weeks_volume"</span>), </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                          <span class="at">k =</span> <span class="dv">5</span>, <span class="at">imp_var =</span> F)  <span class="co"># Adjust k (number of neighbors) as necessary</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Should return 'FALSE' if no missing values</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(train_data_imputed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>Variables were selected before but here you went back to your original un-selected training dataset. Adjusted to go with the datset with variable selections. I’m pretty neutral on imputing the data, my only concern here is that we may need to explain reasoning for choosing KNN imputation, and check assumptions for using this method. My original gut check with this is too assume the same volume change, so percent_change_over_last_week would be zero for imputed values, and previous_weeks_volume would equal volume.</p>
<p>#Apply scaling in prep for modeling</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>normalize_min_max <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  (x <span class="sc">-</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">/</span> (<span class="fu">max</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>) <span class="sc">-</span> <span class="fu">min</span>(x, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="ot">&lt;-</span> train_data_imputed <span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), normalize_min_max))</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="ot">&lt;-</span> test_data_filtered <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is.numeric), normalize_min_max))</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(train_data_imputed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>#Chage Date variable to true date</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="ot">&lt;-</span> train_data_scaled <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">parse_date_time</span>(date, <span class="st">'%m/%d/%Y'</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="ot">&lt;-</span> test_data_scaled <span class="sc">%&gt;%</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">parse_date_time</span>(date, <span class="st">'%m/%d/%Y'</span>))</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(train_data_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>#Create lagged Variables on scaled data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span>  </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_change_price_lag1 =</span> <span class="fu">lag</span>(percent_change_price) </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">head</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        date stock percent_change_next_weeks_price percent_change_price
1 2011-01-07    AA                       0.4770919            0.8338412
2 2011-01-07   AXP                       0.8705239            0.7754923
3 2011-01-07    BA                       0.7098931            0.8811481
4 2011-01-07   BAC                       1.0000000            0.7945878
5 2011-01-07   CAT                       0.7065060            0.6393762
6 2011-01-07  CSCO                       0.7252142            0.7796038
  percent_change_volume_over_last_wk previous_weeks_volume
1                         0.08825424            0.08475325
2                         0.06807195            0.02822541
3                         0.08777741            0.01771123
4                         0.15240536            0.67354126
5                         0.23260218            0.01243852
6                         0.03435266            0.20297610
  days_to_next_dividend percent_return_next_dividend        open        high
1            0.07738095                  0.078157861 0.014022729 0.016286645
2            0.26488095                  0.227004526 0.196650495 0.204429967
3            0.09821429                  0.360186281 0.348508008 0.364039088
4            0.16071429                  0.003070525 0.000930418 0.003061889
5            0.03273810                  0.269484482 0.536120157 0.525016287
6            0.24107143                  0.147166604 0.044792982 0.044169381
          low       close percent_change_price_lag1
1 0.016415321 0.020330033                        NA
2 0.198785533 0.204752475                 0.8338412
3 0.351528093 0.369900990                 0.7754923
4 0.003202989 0.006006601                 0.8811481
5 0.527025224 0.530627063                 0.7945878
6 0.047110637 0.050363036                 0.6393762</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(train_data_scaled)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>Previous method to lag variables does not account for the stock itself. So lag value when ordered by date will pull the values for same date across different stocks.</p>
<p>#Create lagged variables on scaled data version 2</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Need to make train/test data without lags for decision tree</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>train_data_scaled_dt <span class="ot">&lt;-</span> train_data_scaled <span class="sc">%&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span> </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>test_data_scaled_dt <span class="ot">&lt;-</span> test_data_scaled <span class="sc">%&gt;%</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span> </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="ot">&lt;-</span> train_data_scaled <span class="sc">%&gt;%</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span> </span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span>  </span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_change_price_lag1 =</span> <span class="fu">lag</span>(percent_change_price, <span class="at">n =</span> <span class="dv">1</span>) </span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="ot">&lt;-</span> test_data_scaled <span class="sc">%&gt;%</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span> </span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span>  </span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">percent_change_price_lag1 =</span> <span class="fu">lag</span>(percent_change_price, <span class="at">n =</span> <span class="dv">1</span>) </span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> <span class="fu">ungroup</span>()</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(train_data_scaled_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(test_data_scaled_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
</div>
<p>Group by should solve earlier issue</p>
<p>#Plotting the lagged variables to visualize correlation</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(train_data_scaled, <span class="fu">aes</span>(<span class="at">x =</span> percent_change_price_lag1, <span class="at">y =</span> percent_change_price)) <span class="sc">+</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">"lm"</span>, <span class="at">color =</span> <span class="st">"blue"</span>, <span class="at">se =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Lagged Variable Plot: Percentage Change in Price (t) vs (t-1)"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Percentage Change in Price (t-1)"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Percentage Change in Price (t)"</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>`geom_smooth()` using formula = 'y ~ x'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 30 rows containing non-finite outside the scale range
(`stat_smooth()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 30 rows containing missing values or values outside the scale range
(`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tree)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize list to store model fits for each stock</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>tree_fit_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each unique stock and fit a decision tree model</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(train_data_scaled_dt<span class="sc">$</span>stock)) {</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Filter data for the current stock and remove the 'stock' column</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  stock_data <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(train_data_scaled_dt, stock <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>                <span class="fu">select</span>(<span class="sc">-</span>stock)</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit decision tree for the current stock</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  tree_fit <span class="ot">&lt;-</span> <span class="fu">tree</span>(percent_change_next_weeks_price <span class="sc">~</span> ., <span class="at">data =</span> stock_data)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Save the tree model in the list</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>  tree_fit_list[[i]] <span class="ot">&lt;-</span> tree_fit</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Plot the tree for the current stock</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot</span>(tree_fit, <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Decision Tree for Stock:"</span>, i))</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">text</span>(tree_fit, <span class="at">pretty =</span> <span class="dv">0</span>)</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare test data for the current stock and remove 'stock' column</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>  test_data_stock <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">filter</span>(test_data_scaled_dt, stock <span class="sc">==</span> i) <span class="sc">%&gt;%</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>                     <span class="fu">select</span>(<span class="sc">-</span>stock)</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get predictions on the test data for the current stock</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>  dt_preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(tree_fit, <span class="at">newdata =</span> test_data_stock)</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate performance metrics</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>  mse_dt <span class="ot">&lt;-</span> <span class="fu">mean</span>((test_data_stock<span class="sc">$</span>percent_change_next_weeks_price <span class="sc">-</span> dt_preds)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>  mae_dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test_data_stock<span class="sc">$</span>percent_change_next_weeks_price <span class="sc">-</span> dt_preds))</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  me_dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(test_data_stock<span class="sc">$</span>percent_change_next_weeks_price <span class="sc">-</span> dt_preds)</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>  mape_dt <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(test_data_stock<span class="sc">$</span>percent_change_next_weeks_price <span class="sc">-</span> dt_preds) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> test_data_stock<span class="sc">$</span>percent_change_next_weeks_price)</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store metrics in a data frame</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>  performance_metrics[[i]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">stock =</span> i,</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">mse =</span> mse_dt,</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">mae =</span> mae_dt,</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">me =</span> me_dt,</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>                                         <span class="at">mape =</span> mape_dt)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-5.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-6.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-7.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-8.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-9.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-10.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-11.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-12.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-13.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-14.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-15.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-16.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-17.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-18.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-19.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-20.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-21.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-22.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-23.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-24.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-25.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-26.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-27.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-28.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data = stock_data): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-29.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Adding missing grouping variables: `stock`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-16-30.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine all performance metrics into one data frame</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a>all_metrics <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, performance_metrics)</span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(all_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     stock        mse        mae          me     mape
AA      AA 0.05322252 0.19382502 -0.09133227 77.81166
AXP    AXP 0.02167581 0.11133703 -0.01823302 22.52892
BA      BA 0.03244267 0.15913068 -0.12441372 37.06722
BAC    BAC 0.03448501 0.15849657 -0.14042345 43.34520
CAT    CAT 0.11940476 0.29789309 -0.27226954 83.77118
CSCO  CSCO 0.05017155 0.18194744 -0.13508179 49.60234
CVX    CVX 0.09246819 0.27263657 -0.26501356 69.96839
DD      DD 0.06020446 0.20930325 -0.16968914 52.05475
DIS    DIS 0.08694596 0.26367334 -0.24071936 66.86428
GE      GE 0.03079635 0.15192388 -0.11578933 36.02393
HD      HD 0.01974368 0.11545377 -0.11475989 26.58410
HPQ    HPQ 0.07077518 0.21218267 -0.17635176      Inf
IBM    IBM 0.02894203 0.15357094 -0.13319106 30.24130
INTC  INTC 0.04180318 0.17686950 -0.03705417 32.84053
JNJ    JNJ 0.02821279 0.14801135 -0.11931267 29.43891
JPM    JPM 0.06676470 0.22518887 -0.22225660 56.11664
KRFT  KRFT 0.01107153 0.08707076 -0.05697901 16.73778
KO      KO 0.02819114 0.15790526 -0.14422128 32.15918
MCD    MCD 0.03020121 0.16243984 -0.14084828 30.81803
MMM    MMM 0.05995034 0.22449299 -0.21682464 47.58330
MRK    MRK 0.01306311 0.09335757 -0.01735007 17.20444
MSFT  MSFT 0.03119268 0.13754498 -0.09166007 32.14892
PFE    PFE 0.07965402 0.26067289 -0.26067289 56.58037
PG      PG 0.03071934 0.14760085 -0.14760085 31.50668
T        T 0.03399641 0.16812800 -0.16812800 33.96744
TRV    TRV 0.02861440 0.15114180 -0.14159107 33.67949
UTX    UTX 0.02880765 0.15544986 -0.08750087 32.21357
VZ      VZ 0.03192770 0.16039333 -0.14359909 36.00146
WMT    WMT 0.03257089 0.15752213 -0.15752213 32.70360
XOM    XOM 0.06465517 0.21269752 -0.18717201 55.56766</code></pre>
</div>
</div>
<p>#Now applying data subset variables to a regression tree, our target variable is [percent_change_next_weeks_price] so we’re going to use this regression tree to assess our features importance (which ones are most predictive?)</p>
<p>#wrapper outside of tree model/use for loop == stock name/store rmse/mape into frame</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>treefit1 <span class="ot">&lt;-</span> <span class="fu">tree</span>(percent_change_next_weeks_price <span class="sc">~</span> ., <span class="at">data =</span> train_data_scaled_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(percent_change_next_weeks_price ~ ., data =
train_data_scaled_dt): NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(treefit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression tree:
tree(formula = percent_change_next_weeks_price ~ ., data = train_data_scaled_dt)
Variables actually used in tree construction:
[1] "percent_change_price"               "percent_return_next_dividend"      
[3] "open"                               "days_to_next_dividend"             
[5] "previous_weeks_volume"              "high"                              
[7] "percent_change_volume_over_last_wk"
Number of terminal nodes:  18 
Residual mean deviance:  0.008537 = 2.92 / 342 
Distribution of residuals:
     Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
-0.539400 -0.053140  0.003299  0.000000  0.052890  0.264300 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(treefit1)</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(treefit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># If needed, pruning can be performed by specifying the "best" argument </span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>cv.treefit1 <span class="ot">&lt;-</span> <span class="fu">cv.tree</span>(treefit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tree(model = m[rand != i, , drop = FALSE]): NAs introduced by
coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(tree, tree.matrix(nd)): NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb184-1"><a href="#cb184-1" aria-hidden="true" tabindex="-1"></a>best_size <span class="ot">&lt;-</span> cv.treefit1<span class="sc">$</span>size[<span class="fu">which.min</span>(cv.treefit1<span class="sc">$</span>dev)]</span>
<span id="cb184-2"><a href="#cb184-2" aria-hidden="true" tabindex="-1"></a>prune.treefit1 <span class="ot">&lt;-</span> <span class="fu">prune.tree</span>(treefit1, <span class="at">best =</span> best_size)</span>
<span id="cb184-3"><a href="#cb184-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(prune.treefit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        Length Class      Mode   
frame     5    data.frame list   
where   360    -none-     numeric
terms     3    terms      call   
call      3    -none-     call   
y       360    -none-     numeric
weights 360    -none-     numeric</code></pre>
</div>
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb186-1"><a href="#cb186-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(best_size)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb188-1"><a href="#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get predictions on the test data </span></span>
<span id="cb188-2"><a href="#cb188-2" aria-hidden="true" tabindex="-1"></a>dtpreds <span class="ot">&lt;-</span> <span class="fu">predict</span>(treefit1, <span class="at">newdata =</span> test_data_scaled_dt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in pred1.tree(object, tree.matrix(newdata)): NAs introduced by coercion</code></pre>
</div>
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb190-1"><a href="#cb190-1" aria-hidden="true" tabindex="-1"></a>testpreds <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">date =</span> test_data_scaled_dt<span class="sc">$</span>date,</span>
<span id="cb190-2"><a href="#cb190-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">stock =</span> test_data_scaled_dt<span class="sc">$</span>stock,</span>
<span id="cb190-3"><a href="#cb190-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">response =</span> test_data_scaled_dt<span class="sc">$</span>percent_change_next_weeks_price,</span>
<span id="cb190-4"><a href="#cb190-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">dt =</span> dtpreds)</span>
<span id="cb190-5"><a href="#cb190-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-6"><a href="#cb190-6" aria-hidden="true" tabindex="-1"></a>mse_dt <span class="ot">=</span> <span class="fu">mean</span>((testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>dt)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb190-7"><a href="#cb190-7" aria-hidden="true" tabindex="-1"></a>mae_dt <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>dt))</span>
<span id="cb190-8"><a href="#cb190-8" aria-hidden="true" tabindex="-1"></a>me_dt <span class="ot">=</span> <span class="fu">mean</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>dt)</span>
<span id="cb190-9"><a href="#cb190-9" aria-hidden="true" tabindex="-1"></a>mape_dt <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>dt)<span class="sc">*</span><span class="dv">100</span><span class="sc">/</span>testpreds<span class="sc">$</span>response)</span>
<span id="cb190-10"><a href="#cb190-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb190-11"><a href="#cb190-11" aria-hidden="true" tabindex="-1"></a>testperfs <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">dt =</span> <span class="fu">c</span>(mse_dt, mae_dt, me_dt, mape_dt)</span>
<span id="cb190-12"><a href="#cb190-12" aria-hidden="true" tabindex="-1"></a>                        ) <span class="sc">%&gt;%</span> <span class="fu">t</span>()</span>
<span id="cb190-13"><a href="#cb190-13" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(testperfs) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'mse'</span>, <span class="st">'mae'</span>, <span class="st">'me'</span>, <span class="st">'mape'</span>)</span>
<span id="cb190-14"><a href="#cb190-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] ""</code></pre>
</div>
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb192-1"><a href="#cb192-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(testperfs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mse       mae         me mape
dt 0.04696285 0.1865256 -0.1627293  Inf</code></pre>
</div>
</div>
<p>#this looks nuts, not sure what to change to make it better</p>
<p>#gonna try pruning, also using Dr.&nbsp;Roy methods for creating tree</p>
<p>after pruning, best size given is 1, which likely means decision tree won’t work out well anyway. but opting for no pruning for preds, we can always change this</p>
<p>Mape will always be Inf because of zero values for response. Probably don’t even need to include it, but i have it anyway in case we need to talk about why we don’t have it.</p>
</section>
<section id="linear-model" class="level1">
<h1>Linear model</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb194-1"><a href="#cb194-1" aria-hidden="true" tabindex="-1"></a>lmfit1 <span class="ot">&lt;-</span> <span class="fu">step</span>(<span class="fu">lm</span>(percent_change_next_weeks_price <span class="sc">~</span> . <span class="sc">-</span> percent_change_price_lag1, <span class="at">data =</span> <span class="fu">na.omit</span>(train_data_scaled)), <span class="at">method =</span> <span class="st">'both'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Start:  AIC=-1476.33
percent_change_next_weeks_price ~ (date + stock + percent_change_price + 
    percent_change_volume_over_last_wk + previous_weeks_volume + 
    days_to_next_dividend + percent_return_next_dividend + open + 
    high + low + close + percent_change_price_lag1) - percent_change_price_lag1

                                     Df Sum of Sq    RSS     AIC
- stock                              29   0.52702 3.4804 -1480.1
- date                                1   0.00000 2.9534 -1478.3
- previous_weeks_volume               1   0.00104 2.9544 -1478.2
- close                               1   0.00141 2.9548 -1478.2
- percent_change_volume_over_last_wk  1   0.00504 2.9584 -1477.8
- low                                 1   0.00743 2.9608 -1477.5
- percent_change_price                1   0.01436 2.9677 -1476.7
- percent_return_next_dividend        1   0.01771 2.9711 -1476.3
&lt;none&gt;                                            2.9534 -1476.3
- high                                1   0.02980 2.9832 -1475.0
- open                                1   0.03125 2.9846 -1474.8
- days_to_next_dividend               1   0.04279 2.9962 -1473.6

Step:  AIC=-1480.14
percent_change_next_weeks_price ~ date + percent_change_price + 
    percent_change_volume_over_last_wk + previous_weeks_volume + 
    days_to_next_dividend + percent_return_next_dividend + open + 
    high + low + close

                                     Df Sum of Sq    RSS     AIC
- close                               1  0.000270 3.4807 -1482.1
- days_to_next_dividend               1  0.001016 3.4814 -1482.0
- percent_change_volume_over_last_wk  1  0.005272 3.4857 -1481.6
- date                                1  0.008586 3.4890 -1481.3
- percent_change_price                1  0.009021 3.4894 -1481.3
- low                                 1  0.014210 3.4946 -1480.8
- previous_weeks_volume               1  0.015808 3.4962 -1480.7
&lt;none&gt;                                            3.4804 -1480.1
- open                                1  0.023558 3.5039 -1479.9
- high                                1  0.049490 3.5299 -1477.5
- percent_return_next_dividend        1  0.053589 3.5340 -1477.1

Step:  AIC=-1482.12
percent_change_next_weeks_price ~ date + percent_change_price + 
    percent_change_volume_over_last_wk + previous_weeks_volume + 
    days_to_next_dividend + percent_return_next_dividend + open + 
    high + low

                                     Df Sum of Sq    RSS     AIC
- days_to_next_dividend               1  0.001025 3.4817 -1484.0
- percent_change_volume_over_last_wk  1  0.005458 3.4861 -1483.6
- date                                1  0.008370 3.4890 -1483.3
- percent_change_price                1  0.011180 3.4918 -1483.1
- previous_weeks_volume               1  0.015845 3.4965 -1482.6
- low                                 1  0.017976 3.4986 -1482.4
&lt;none&gt;                                            3.4807 -1482.1
- open                                1  0.023333 3.5040 -1481.9
- percent_return_next_dividend        1  0.053340 3.5340 -1479.1
- high                                1  0.075192 3.5559 -1477.1

Step:  AIC=-1484.02
percent_change_next_weeks_price ~ date + percent_change_price + 
    percent_change_volume_over_last_wk + previous_weeks_volume + 
    percent_return_next_dividend + open + high + low

                                     Df Sum of Sq    RSS     AIC
- percent_change_volume_over_last_wk  1  0.005286 3.4870 -1485.5
- date                                1  0.008680 3.4904 -1485.2
- percent_change_price                1  0.011739 3.4934 -1484.9
- previous_weeks_volume               1  0.015311 3.4970 -1484.6
- low                                 1  0.017281 3.4990 -1484.4
&lt;none&gt;                                            3.4817 -1484.0
- open                                1  0.023969 3.5057 -1483.8
- percent_return_next_dividend        1  0.052632 3.5343 -1481.1
- high                                1  0.074774 3.5565 -1479.0

Step:  AIC=-1485.52
percent_change_next_weeks_price ~ date + percent_change_price + 
    previous_weeks_volume + percent_return_next_dividend + open + 
    high + low

                               Df Sum of Sq    RSS     AIC
- date                          1  0.007495 3.4945 -1486.8
- percent_change_price          1  0.007767 3.4947 -1486.8
- previous_weeks_volume         1  0.012511 3.4995 -1486.3
- low                           1  0.013019 3.5000 -1486.3
- open                          1  0.020783 3.5078 -1485.6
&lt;none&gt;                                      3.4870 -1485.5
- percent_return_next_dividend  1  0.052272 3.5392 -1482.6
- high                          1  0.072769 3.5597 -1480.7

Step:  AIC=-1486.81
percent_change_next_weeks_price ~ percent_change_price + previous_weeks_volume + 
    percent_return_next_dividend + open + high + low

                               Df Sum of Sq    RSS     AIC
- percent_change_price          1  0.008126 3.5026 -1488.0
- low                           1  0.009910 3.5044 -1487.9
- previous_weeks_volume         1  0.012522 3.5070 -1487.6
&lt;none&gt;                                      3.4945 -1486.8
- open                          1  0.025648 3.5201 -1486.4
- percent_return_next_dividend  1  0.051478 3.5459 -1484.0
- high                          1  0.073448 3.5679 -1482.0

Step:  AIC=-1488.04
percent_change_next_weeks_price ~ previous_weeks_volume + percent_return_next_dividend + 
    open + high + low

                               Df Sum of Sq    RSS     AIC
- previous_weeks_volume         1  0.012606 3.5152 -1488.9
- open                          1  0.018407 3.5210 -1488.3
&lt;none&gt;                                      3.5026 -1488.0
- low                           1  0.026378 3.5290 -1487.6
- percent_return_next_dividend  1  0.049864 3.5525 -1485.4
- high                          1  0.065420 3.5680 -1483.9

Step:  AIC=-1488.86
percent_change_next_weeks_price ~ percent_return_next_dividend + 
    open + high + low

                               Df Sum of Sq    RSS     AIC
- open                          1  0.017527 3.5327 -1489.2
&lt;none&gt;                                      3.5152 -1488.9
- low                           1  0.027585 3.5428 -1488.3
- high                          1  0.066410 3.5816 -1484.7
- percent_return_next_dividend  1  0.086604 3.6018 -1482.8

Step:  AIC=-1489.22
percent_change_next_weeks_price ~ percent_return_next_dividend + 
    high + low

                               Df Sum of Sq    RSS     AIC
&lt;none&gt;                                      3.5327 -1489.2
- low                           1  0.046444 3.5792 -1486.9
- high                          1  0.050043 3.5828 -1486.6
- percent_return_next_dividend  1  0.081289 3.6140 -1483.7</code></pre>
</div>
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb196-1"><a href="#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lmfit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = percent_change_next_weeks_price ~ percent_return_next_dividend + 
    high + low, data = na.omit(train_data_scaled))

Residuals:
     Min       1Q   Median       3Q      Max 
-0.64864 -0.06253  0.00166  0.05809  0.29339 

Coefficients:
                             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                   0.63122    0.01543  40.917   &lt;2e-16 ***
percent_return_next_dividend  0.07561    0.02761   2.739   0.0065 ** 
high                          1.96449    0.91417   2.149   0.0324 *  
low                          -1.91623    0.92561  -2.070   0.0392 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.1041 on 326 degrees of freedom
Multiple R-squared:  0.04498,   Adjusted R-squared:  0.03619 
F-statistic: 5.118 on 3 and 326 DF,  p-value: 0.001795</code></pre>
</div>
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb198-1"><a href="#cb198-1" aria-hidden="true" tabindex="-1"></a>lmpreds <span class="ot">&lt;-</span> <span class="fu">predict</span>(lmfit1, test_data_scaled)</span>
<span id="cb198-2"><a href="#cb198-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-3"><a href="#cb198-3" aria-hidden="true" tabindex="-1"></a>testpreds<span class="sc">$</span>lm <span class="ot">&lt;-</span> lmpreds</span>
<span id="cb198-4"><a href="#cb198-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-5"><a href="#cb198-5" aria-hidden="true" tabindex="-1"></a>mse_lm <span class="ot">=</span> <span class="fu">mean</span>((testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>lm)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb198-6"><a href="#cb198-6" aria-hidden="true" tabindex="-1"></a>mae_lm <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>lm))</span>
<span id="cb198-7"><a href="#cb198-7" aria-hidden="true" tabindex="-1"></a>me_lm <span class="ot">=</span> <span class="fu">mean</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>lm)</span>
<span id="cb198-8"><a href="#cb198-8" aria-hidden="true" tabindex="-1"></a>mape_lm <span class="ot">=</span> <span class="fu">mean</span>(<span class="fu">abs</span>(testpreds<span class="sc">$</span>response <span class="sc">-</span> testpreds<span class="sc">$</span>lm)<span class="sc">*</span><span class="dv">100</span><span class="sc">/</span>testpreds<span class="sc">$</span>response)</span>
<span id="cb198-9"><a href="#cb198-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-10"><a href="#cb198-10" aria-hidden="true" tabindex="-1"></a>testperfs <span class="ot">&lt;-</span> <span class="fu">rbind</span>(testperfs, <span class="at">lm =</span> <span class="fu">c</span>(mse_lm, mae_lm, me_lm, mape_lm))</span>
<span id="cb198-11"><a href="#cb198-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(testperfs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          mse       mae         me mape
dt 0.04696285 0.1865256 -0.1627293  Inf
lm 0.04333632 0.1796067 -0.1556633  Inf</code></pre>
</div>
</div>
<p>I had issues with missing values from the lag variable, so may need to bring this up to the professor later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lmfit1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-19-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-19-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="svr" class="level1">
<h1>SVR</h1>
<p>SVR is omitting the rows with the NA for percent_change_price_lag1, so removing that variable here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>train_data_scaled <span class="ot">&lt;-</span> train_data_scaled[ , <span class="fu">names</span>(train_data_scaled) <span class="sc">!=</span> <span class="st">'percent_change_price_lag1'</span>]</span>
<span id="cb201-2"><a href="#cb201-2" aria-hidden="true" tabindex="-1"></a>test_data_scaled <span class="ot">&lt;-</span> test_data_scaled[ , <span class="fu">names</span>(test_data_scaled) <span class="sc">!=</span> <span class="st">'percent_change_price_lag1'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb202"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb202-1"><a href="#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "AA"   "AXP"  "BA"   "BAC"  "CAT"  "CSCO" "CVX"  "DD"   "DIS"  "GE"  
[11] "HD"   "HPQ"  "IBM"  "INTC" "JNJ"  "JPM"  "KRFT" "KO"   "MCD"  "MMM" 
[21] "MRK"  "MSFT" "PFE"  "PG"   "T"    "TRV"  "UTX"  "VZ"   "WMT"  "XOM" </code></pre>
</div>
</div>
<p>Getting idea of parameters without for loop since it wouldn’t behave on its own. This was primarily just research and does need to be repeated for other models.</p>
<pre><code>form1 &lt;- percent_change_next_weeks_price ~ . - percent_change_price_lag1

svr_tune_lists &lt;- list() 
best_Params_list &lt;- list()

set.seed(123)
svr_tune_lists[['AA']] &lt;- tune.svm(form1, data = filter(train_data_scaled, stock == 'AA')[, names(train_data_scaled) != 'stock'],
                                   gamma = seq(.01,.1, by = .01), cost = seq(2.2, 2.5, by = .01), scale = T
                                   )
print(svr_tune_lists[['AA']])

set.seed(123)
svr_tune_lists[['AXP']] &lt;- tune.svm(form1, data = filter(train_data_scaled, stock == 'AXP')[, names(train_data_scaled) != 'stock'],
                                   gamma = seq(.001,.01, by = .001), cost = seq(9, 10, by = .05), scale = T
                                   )
print(svr_tune_lists[['AXP']])

set.seed(123)
svr_tune_lists[['BA']] &lt;- tune.svm(form1, data = filter(train_data_scaled, stock == 'BA')[, names(train_data_scaled) != 'stock'],
                                   gamma = seq(.01,.1, by = .01), cost = seq(1.5, 2.5, by = .1), scale = T
                                   )
print(svr_tune_lists[['BA']])

set.seed(123)
svr_tune_lists[['BA']] &lt;- tune.svm(form1, data = filter(train_data_scaled, stock == 'BA')[, names(train_data_scaled) != 'stock'],
                                   gamma = seq(.01,.1, by = .01), cost = seq(1.5, 2.5, by = .1), scale = T
                                   )
print(svr_tune_lists[['BA']])</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>form1 <span class="ot">&lt;-</span> percent_change_next_weeks_price <span class="sc">~</span> .</span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>svr_tune_lists <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># initiate models list</span></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>best_Params_list <span class="ot">&lt;-</span> <span class="fu">list</span>() <span class="co"># initiate list of best parameters for SVR for each stock</span></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock))) {</span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>  svr_tune_lists[[i]] <span class="ot">&lt;-</span>  <span class="fu">tune.svm</span>(form1, <span class="at">data =</span> <span class="fu">filter</span>(train_data_scaled, stock <span class="sc">==</span> i)[, <span class="fu">names</span>(train_data_scaled) <span class="sc">!=</span> <span class="st">'stock'</span>],</span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">gamma =</span> <span class="fu">seq</span>(.<span class="dv">005</span>,.<span class="dv">1</span>, <span class="at">by =</span> .<span class="dv">005</span>), <span class="at">cost =</span> <span class="fu">seq</span>(<span class="dv">1</span>, <span class="dv">10</span>, <span class="at">by =</span> <span class="dv">1</span>), <span class="at">scale =</span> T</span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a>                                   )</span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a>  best_Params_list[[i]] <span class="ot">&lt;-</span> svr_tune_lists[[i]]<span class="sc">$</span>best.parameters</span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>checks for any models that did not predict because of bad tuning parameters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb206"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb206-1"><a href="#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock))) {</span>
<span id="cb206-2"><a href="#cb206-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">is.na</span>(best_Params_list[[i]]<span class="sc">$</span>gamma))</span>
<span id="cb206-3"><a href="#cb206-3" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE
[1] FALSE</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb208"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb208-1"><a href="#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is the part to copy for the other models</span></span>
<span id="cb208-2"><a href="#cb208-2" aria-hidden="true" tabindex="-1"></a>svr_fit_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb208-3"><a href="#cb208-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-4"><a href="#cb208-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock))) {</span>
<span id="cb208-5"><a href="#cb208-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb208-6"><a href="#cb208-6" aria-hidden="true" tabindex="-1"></a>  svr_fit_list[[i]] <span class="ot">&lt;-</span>  <span class="fu">svm</span>(form1, <span class="at">data =</span> <span class="fu">filter</span>(train_data_scaled, stock <span class="sc">==</span> i)[, <span class="fu">names</span>(train_data_scaled) <span class="sc">!=</span> <span class="st">'stock'</span>],</span>
<span id="cb208-7"><a href="#cb208-7" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">gamma =</span> best_Params_list[[i]]<span class="sc">$</span>gamma, <span class="at">cost =</span> best_Params_list[[i]]<span class="sc">$</span>cost, <span class="at">scale =</span> T</span>
<span id="cb208-8"><a href="#cb208-8" aria-hidden="true" tabindex="-1"></a>                                   )</span>
<span id="cb208-9"><a href="#cb208-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>this is used to print the summary of each model. Useful if you want to look, but the output is huge and blows up the view a bit.</p>
<pre><code>for (i in c(unique(train_data_scaled$stock))) {
    print(summary(svr_fit_list[[i]]))
}
</code></pre>
<p>stores predictions and other identifying variables into a list of dataframes. This is flattened later into one dataframe, but must start as a list in order to more easily iterate through the stocks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb210"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb210-1"><a href="#cb210-1" aria-hidden="true" tabindex="-1"></a>newpreds <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb210-2"><a href="#cb210-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock))) {</span>
<span id="cb210-3"><a href="#cb210-3" aria-hidden="true" tabindex="-1"></a>  newpreds[[i]] <span class="ot">&lt;-</span> test_data_scaled <span class="sc">%&gt;%</span> <span class="fu">filter</span>(stock <span class="sc">==</span> i) <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, stock, percent_change_next_weeks_price) <span class="co"># first model needs this line, all others can skip</span></span>
<span id="cb210-4"><a href="#cb210-4" aria-hidden="true" tabindex="-1"></a>  newpreds[[i]]<span class="sc">$</span>svr <span class="ot">&lt;-</span> <span class="fu">predict</span>(svr_fit_list[[i]], <span class="fu">filter</span>(test_data_scaled, stock <span class="sc">==</span> i)[, <span class="fu">names</span>(test_data_scaled) <span class="sc">!=</span> <span class="st">'stock'</span>])</span>
<span id="cb210-5"><a href="#cb210-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>we do this step only once we have all predictions for all models saved to the list like we do above</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>predsdf <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(newpreds, <span class="at">.id =</span> <span class="st">"column_label"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>gets MSE for just SVR for now.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb212"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb212-1"><a href="#cb212-1" aria-hidden="true" tabindex="-1"></a>predsdf <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span> </span>
<span id="cb212-2"><a href="#cb212-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb212-3"><a href="#cb212-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">SVR =</span> <span class="fu">mean</span>((<span class="fu">na.omit</span>(percent_change_next_weeks_price) <span class="sc">-</span> svr)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb212-4"><a href="#cb212-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 2
   stock    SVR
   &lt;chr&gt;  &lt;dbl&gt;
 1 AA    0.0549
 2 AXP   0.0278
 3 BA    0.0627
 4 BAC   0.0248
 5 CAT   0.172 
 6 CSCO  0.0432
 7 CVX   0.0898
 8 DD    0.0491
 9 DIS   0.0933
10 GE    0.0617
# ℹ 20 more rows</code></pre>
</div>
</div>
<p>Overall MSE</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb214"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb214-1"><a href="#cb214-1" aria-hidden="true" tabindex="-1"></a>predsdf <span class="sc">%&gt;%</span> </span>
<span id="cb214-2"><a href="#cb214-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb214-3"><a href="#cb214-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">SVR =</span> <span class="fu">mean</span>((<span class="fu">na.omit</span>(percent_change_next_weeks_price) <span class="sc">-</span> svr)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb214-4"><a href="#cb214-4" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
     SVR
   &lt;dbl&gt;
1 0.0484</code></pre>
</div>
</div>
</section>
<section id="picking-up-where-will-left-off-from-here.-this-part-adds-for-lm---holly" class="level1">
<h1>PICKING UP WHERE WILL LEFT OFF FROM HERE. THIS PART ADDS FOR LM - HOLLY</h1>
<p>#Have to define the formula when using LM since it doesn’t perform the same as SVR when it comes to feature selection</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb216"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb216-1"><a href="#cb216-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Defining the formula for LM dynamically to use all existing variables except 'percent_change_next_weeks_price'</span></span>
<span id="cb216-2"><a href="#cb216-2" aria-hidden="true" tabindex="-1"></a>lm_formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"percent_change_next_weeks_price ~ ."</span>))</span>
<span id="cb216-3"><a href="#cb216-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-4"><a href="#cb216-4" aria-hidden="true" tabindex="-1"></a>lm_fit_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb216-5"><a href="#cb216-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb216-6"><a href="#cb216-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(train_data_scaled<span class="sc">$</span>stock)) {</span>
<span id="cb216-7"><a href="#cb216-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb216-8"><a href="#cb216-8" aria-hidden="true" tabindex="-1"></a>  stock_data <span class="ot">&lt;-</span> <span class="fu">filter</span>(train_data_scaled, stock <span class="sc">==</span> i) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>stock)</span>
<span id="cb216-9"><a href="#cb216-9" aria-hidden="true" tabindex="-1"></a>  lm_fit_list[[i]] <span class="ot">&lt;-</span> <span class="fu">lm</span>(lm_formula, <span class="at">data =</span> stock_data)</span>
<span id="cb216-10"><a href="#cb216-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#Adding my LM predictions to the ‘newpreds’ list</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">unique</span>(test_data_scaled<span class="sc">$</span>stock)) {</span>
<span id="cb217-2"><a href="#cb217-2" aria-hidden="true" tabindex="-1"></a>  newpreds[[i]]<span class="sc">$</span>lm_pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(lm_fit_list[[i]], <span class="at">newdata =</span> <span class="fu">filter</span>(test_data_scaled, stock <span class="sc">==</span> i))</span>
<span id="cb217-3"><a href="#cb217-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb217-4"><a href="#cb217-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb217-5"><a href="#cb217-5" aria-hidden="true" tabindex="-1"></a>combined_preds_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(newpreds, <span class="at">.id =</span> <span class="st">"stock"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>#Comparing what we have so far with LM and SVR using MSE/MAE/MAPE for each model and stock</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb218"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb218-1"><a href="#cb218-1" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="ot">&lt;-</span> combined_preds_df <span class="sc">%&gt;%</span></span>
<span id="cb218-2"><a href="#cb218-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(stock) <span class="sc">%&gt;%</span></span>
<span id="cb218-3"><a href="#cb218-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb218-4"><a href="#cb218-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE_LM =</span> <span class="fu">mean</span>((percent_change_next_weeks_price <span class="sc">-</span> lm_pred)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb218-5"><a href="#cb218-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_LM =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(percent_change_next_weeks_price <span class="sc">-</span> lm_pred), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb218-6"><a href="#cb218-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAPE_LM =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(percent_change_next_weeks_price <span class="sc">-</span> lm_pred) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> <span class="fu">abs</span>(percent_change_next_weeks_price), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb218-7"><a href="#cb218-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb218-8"><a href="#cb218-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">MSE_SVR =</span> <span class="fu">mean</span>((percent_change_next_weeks_price <span class="sc">-</span> svr)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb218-9"><a href="#cb218-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_SVR =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(percent_change_next_weeks_price <span class="sc">-</span> svr), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb218-10"><a href="#cb218-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAPE_SVR =</span> <span class="fu">mean</span>(<span class="fu">abs</span>(percent_change_next_weeks_price <span class="sc">-</span> svr) <span class="sc">*</span> <span class="dv">100</span> <span class="sc">/</span> <span class="fu">abs</span>(percent_change_next_weeks_price), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb218-11"><a href="#cb218-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb218-12"><a href="#cb218-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb218-13"><a href="#cb218-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(performance_metrics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 7
   stock  MSE_LM MAE_LM MAPE_LM MSE_SVR MAE_SVR MAPE_SVR
   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;
 1 AA    353.    18.7     5169.  0.0549   0.195     81.1
 2 AXP   281.    16.7     3153.  0.0278   0.131     26.2
 3 BA     10.3    3.09     639.  0.0627   0.221     52.1
 4 BAC   855.    26.0     5966.  0.0248   0.128     27.5
 5 CAT     0.423  0.572    148.  0.172    0.359    100. 
 6 CSCO    1.88   1.25     280.  0.0432   0.180     48.1
 7 CVX     8.46   2.84     593.  0.0898   0.269     68.9
 8 DD     25.7    5.03    1067.  0.0491   0.171     46.0
 9 DIS    88.3    9.29    2074.  0.0933   0.275     70.6
10 GE    120.    10.8     2287.  0.0617   0.232     54.9
# ℹ 20 more rows</code></pre>
</div>
</div>
<p>#Interpretation of output: #LM does not seem to be performing well compared to SVR (this could be do to it not handling outliers well?).SVR Outperforms LM in MSE and MAE- has lower MSE and MAE values across most stocks, indicating it may have a better fit to the data than LM. For example, for stock AA, MSE_SVR is 0.0546 compared to MSE_LM of 353.17. This pattern holds for many stocks, showing SVR may be a better choice here.Additionally, MAPE values for LM are significantly higher than those for SVR in most cases, which suggests that SVR’s predictions are relatively closer to actual values as a percentage. Some of the MAPE values for LM are very large (like 5168.89 for AA), which might indicate that LM struggles with certain stocks, potentially due to variability or outliers in the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb220"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb220-1"><a href="#cb220-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting Actual vs. Predicted for LM and SVR</span></span>
<span id="cb220-2"><a href="#cb220-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(combined_preds_df, <span class="fu">aes</span>(<span class="at">x =</span> percent_change_next_weeks_price)) <span class="sc">+</span></span>
<span id="cb220-3"><a href="#cb220-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> lm_pred, <span class="at">color =</span> <span class="st">"LM"</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb220-4"><a href="#cb220-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> svr, <span class="at">color =</span> <span class="st">"SVR"</span>), <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb220-5"><a href="#cb220-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="dv">0</span>, <span class="at">slope =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="cb220-6"><a href="#cb220-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb220-7"><a href="#cb220-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Actual vs Predicted Values for LM and SVR"</span>,</span>
<span id="cb220-8"><a href="#cb220-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Actual Percent Change Next Week's Price"</span>,</span>
<span id="cb220-9"><a href="#cb220-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Predicted Percent Change Next Week's Price"</span></span>
<span id="cb220-10"><a href="#cb220-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb220-11"><a href="#cb220-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> stock) <span class="sc">+</span></span>
<span id="cb220-12"><a href="#cb220-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">name =</span> <span class="st">"Model"</span>, <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"LM"</span> <span class="ot">=</span> <span class="st">"blue"</span>, <span class="st">"SVR"</span> <span class="ot">=</span> <span class="st">"red"</span>)) <span class="sc">+</span></span>
<span id="cb220-13"><a href="#cb220-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="CS3_Sandbox_TH_files/figure-html/unnamed-chunk-32-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Holly Comments/observations: Regression Tree and Pruning pruning resulting in only one node suggests that the tree might not capture much complexity in the data, possibly due to: Limited predictive strength of the features relative to the target This may be good to consider alternate models, as we will do with Linear Regression (LM) and SVR, to assess if these might capture the patterns better</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>